<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>离屏渲染 | 洋仔的博客</title>
    <meta name="generator" content="VuePress 1.9.9">
    <link rel="icon" href="/img/favicon.ico">
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    <meta name="description" content="专心做事，用心总结">
    <meta name="keywords" content="前端博客,个人技术博客,前端,前端开发,前端框架,web前端,前端面试题,技术文档,学习,面试,JavaScript,js,ES6,TypeScript,vue,python,css3,html5,Node,git,github,markdown">
    <meta name="baidu-site-verification" content="7F55weZDDc">
    <meta name="theme-color" content="#11a8cd">
    
    <link rel="preload" href="/assets/css/0.styles.55beba5e.css" as="style"><link rel="preload" href="/assets/js/app.cc55d274.js" as="script"><link rel="preload" href="/assets/js/2.81b2a5fe.js" as="script"><link rel="preload" href="/assets/js/58.4de20d90.js" as="script"><link rel="prefetch" href="/assets/js/10.fd87ea06.js"><link rel="prefetch" href="/assets/js/100.033c06ef.js"><link rel="prefetch" href="/assets/js/101.1c0e8fbb.js"><link rel="prefetch" href="/assets/js/102.820c15ea.js"><link rel="prefetch" href="/assets/js/103.1f4387c0.js"><link rel="prefetch" href="/assets/js/104.6b56fc18.js"><link rel="prefetch" href="/assets/js/105.7e174701.js"><link rel="prefetch" href="/assets/js/106.e7ed90dd.js"><link rel="prefetch" href="/assets/js/107.5dff726f.js"><link rel="prefetch" href="/assets/js/108.1b4254ab.js"><link rel="prefetch" href="/assets/js/109.db801d19.js"><link rel="prefetch" href="/assets/js/11.4cd9f768.js"><link rel="prefetch" href="/assets/js/110.51ed8450.js"><link rel="prefetch" href="/assets/js/111.1ed05a5b.js"><link rel="prefetch" href="/assets/js/112.d7f263da.js"><link rel="prefetch" href="/assets/js/113.dea11b47.js"><link rel="prefetch" href="/assets/js/114.ad6403dc.js"><link rel="prefetch" href="/assets/js/115.28cf40c7.js"><link rel="prefetch" href="/assets/js/116.02bcdc6e.js"><link rel="prefetch" href="/assets/js/117.75a9e1eb.js"><link rel="prefetch" href="/assets/js/118.03e0d0e9.js"><link rel="prefetch" href="/assets/js/119.766321d8.js"><link rel="prefetch" href="/assets/js/12.1f119179.js"><link rel="prefetch" href="/assets/js/120.4acf5e51.js"><link rel="prefetch" href="/assets/js/121.a4fcaab7.js"><link rel="prefetch" href="/assets/js/122.d2cc02cb.js"><link rel="prefetch" href="/assets/js/123.c4c3b254.js"><link rel="prefetch" href="/assets/js/124.55aefdfc.js"><link rel="prefetch" href="/assets/js/125.33021e89.js"><link rel="prefetch" href="/assets/js/126.bf744470.js"><link rel="prefetch" href="/assets/js/127.d1b1efb8.js"><link rel="prefetch" href="/assets/js/128.8c1b4252.js"><link rel="prefetch" href="/assets/js/129.ac017f9f.js"><link rel="prefetch" href="/assets/js/13.0f009df8.js"><link rel="prefetch" href="/assets/js/130.fdc573c0.js"><link rel="prefetch" href="/assets/js/131.c4f70462.js"><link rel="prefetch" href="/assets/js/132.d874068e.js"><link rel="prefetch" href="/assets/js/133.3344bf55.js"><link rel="prefetch" href="/assets/js/134.86c9bfea.js"><link rel="prefetch" href="/assets/js/135.7761e325.js"><link rel="prefetch" href="/assets/js/136.99654544.js"><link rel="prefetch" href="/assets/js/137.25867633.js"><link rel="prefetch" href="/assets/js/138.3016a91b.js"><link rel="prefetch" href="/assets/js/139.ead29e5f.js"><link rel="prefetch" href="/assets/js/14.1c908535.js"><link rel="prefetch" href="/assets/js/140.2217ee0f.js"><link rel="prefetch" href="/assets/js/141.faed4896.js"><link rel="prefetch" href="/assets/js/142.3786cfaa.js"><link rel="prefetch" href="/assets/js/143.680d45a4.js"><link rel="prefetch" href="/assets/js/144.5e0d30d9.js"><link rel="prefetch" href="/assets/js/145.a2c5cf58.js"><link rel="prefetch" href="/assets/js/146.215c3961.js"><link rel="prefetch" href="/assets/js/147.81e5dbea.js"><link rel="prefetch" href="/assets/js/148.7ef156fa.js"><link rel="prefetch" href="/assets/js/149.07344fb0.js"><link rel="prefetch" href="/assets/js/15.24686777.js"><link rel="prefetch" href="/assets/js/150.100e1276.js"><link rel="prefetch" href="/assets/js/151.5a0852bd.js"><link rel="prefetch" href="/assets/js/152.d0e587d9.js"><link rel="prefetch" href="/assets/js/153.007ec2d1.js"><link rel="prefetch" href="/assets/js/154.3178d124.js"><link rel="prefetch" href="/assets/js/155.53357b05.js"><link rel="prefetch" href="/assets/js/156.d5438e93.js"><link rel="prefetch" href="/assets/js/157.8afa8209.js"><link rel="prefetch" href="/assets/js/158.0434bf90.js"><link rel="prefetch" href="/assets/js/159.64687b5f.js"><link rel="prefetch" href="/assets/js/16.12f4db26.js"><link rel="prefetch" href="/assets/js/160.56d76ff4.js"><link rel="prefetch" href="/assets/js/161.f6414d3f.js"><link rel="prefetch" href="/assets/js/162.b9de4b51.js"><link rel="prefetch" href="/assets/js/163.07e063ef.js"><link rel="prefetch" href="/assets/js/164.3acfc294.js"><link rel="prefetch" href="/assets/js/165.66703a7d.js"><link rel="prefetch" href="/assets/js/166.cb851667.js"><link rel="prefetch" href="/assets/js/167.4098c444.js"><link rel="prefetch" href="/assets/js/168.a80d728b.js"><link rel="prefetch" href="/assets/js/169.bd937a75.js"><link rel="prefetch" href="/assets/js/17.6c77ddb7.js"><link rel="prefetch" href="/assets/js/170.e3d78c48.js"><link rel="prefetch" href="/assets/js/171.bceae2ae.js"><link rel="prefetch" href="/assets/js/172.ce9b722c.js"><link rel="prefetch" href="/assets/js/173.e47f9666.js"><link rel="prefetch" href="/assets/js/174.7997805c.js"><link rel="prefetch" href="/assets/js/175.00237921.js"><link rel="prefetch" href="/assets/js/176.0fa3c92e.js"><link rel="prefetch" href="/assets/js/177.78d4055c.js"><link rel="prefetch" href="/assets/js/178.3b9e2d49.js"><link rel="prefetch" href="/assets/js/179.ffd38cbc.js"><link rel="prefetch" href="/assets/js/18.bdd3ef44.js"><link rel="prefetch" href="/assets/js/180.ea1e7437.js"><link rel="prefetch" href="/assets/js/181.1b990f8f.js"><link rel="prefetch" href="/assets/js/182.2294fb00.js"><link rel="prefetch" href="/assets/js/183.d49c9d33.js"><link rel="prefetch" href="/assets/js/184.ad8b9900.js"><link rel="prefetch" href="/assets/js/185.da48669b.js"><link rel="prefetch" href="/assets/js/186.650a47d2.js"><link rel="prefetch" href="/assets/js/187.dc3e7f5f.js"><link rel="prefetch" href="/assets/js/188.d372ce27.js"><link rel="prefetch" href="/assets/js/189.fa1c9909.js"><link rel="prefetch" href="/assets/js/19.10c0d5b8.js"><link rel="prefetch" href="/assets/js/190.6c1b8013.js"><link rel="prefetch" href="/assets/js/191.6676590e.js"><link rel="prefetch" href="/assets/js/192.cb1953e2.js"><link rel="prefetch" href="/assets/js/193.a6ae7e91.js"><link rel="prefetch" href="/assets/js/194.2ebc2436.js"><link rel="prefetch" href="/assets/js/195.35be6114.js"><link rel="prefetch" href="/assets/js/196.b360067a.js"><link rel="prefetch" href="/assets/js/197.c0234eef.js"><link rel="prefetch" href="/assets/js/198.6231b11b.js"><link rel="prefetch" href="/assets/js/199.838ff34e.js"><link rel="prefetch" href="/assets/js/20.92725459.js"><link rel="prefetch" href="/assets/js/200.5dc57180.js"><link rel="prefetch" href="/assets/js/201.39e5421a.js"><link rel="prefetch" href="/assets/js/202.0a56fa31.js"><link rel="prefetch" href="/assets/js/203.90d6ea32.js"><link rel="prefetch" href="/assets/js/204.48311b42.js"><link rel="prefetch" href="/assets/js/205.e1f37224.js"><link rel="prefetch" href="/assets/js/206.92c38d74.js"><link rel="prefetch" href="/assets/js/207.3493f997.js"><link rel="prefetch" href="/assets/js/208.d2d00438.js"><link rel="prefetch" href="/assets/js/209.7ff3e1db.js"><link rel="prefetch" href="/assets/js/21.703ec124.js"><link rel="prefetch" href="/assets/js/210.b9e087c1.js"><link rel="prefetch" href="/assets/js/211.0b5f6ae5.js"><link rel="prefetch" href="/assets/js/212.5a5a4e85.js"><link rel="prefetch" href="/assets/js/213.ddea0aff.js"><link rel="prefetch" href="/assets/js/214.06e03126.js"><link rel="prefetch" href="/assets/js/215.99e71be9.js"><link rel="prefetch" href="/assets/js/216.5ab77662.js"><link rel="prefetch" href="/assets/js/217.5b8b2a56.js"><link rel="prefetch" href="/assets/js/218.656d4df8.js"><link rel="prefetch" href="/assets/js/219.2f9282d7.js"><link rel="prefetch" href="/assets/js/22.7832c9ca.js"><link rel="prefetch" href="/assets/js/220.05012b4c.js"><link rel="prefetch" href="/assets/js/221.150b41d4.js"><link rel="prefetch" href="/assets/js/222.18bfe57a.js"><link rel="prefetch" href="/assets/js/223.5d9b036a.js"><link rel="prefetch" href="/assets/js/224.cd5efc56.js"><link rel="prefetch" href="/assets/js/225.fe1ef215.js"><link rel="prefetch" href="/assets/js/226.b5602968.js"><link rel="prefetch" href="/assets/js/227.9f3fc228.js"><link rel="prefetch" href="/assets/js/228.a9a155dc.js"><link rel="prefetch" href="/assets/js/229.53d80ddd.js"><link rel="prefetch" href="/assets/js/23.8e2d40f9.js"><link rel="prefetch" href="/assets/js/230.4918b1a6.js"><link rel="prefetch" href="/assets/js/231.ca415abb.js"><link rel="prefetch" href="/assets/js/232.04bfb190.js"><link rel="prefetch" href="/assets/js/233.d2a40489.js"><link rel="prefetch" href="/assets/js/234.e2aacb9a.js"><link rel="prefetch" href="/assets/js/235.163536f8.js"><link rel="prefetch" href="/assets/js/236.6c845360.js"><link rel="prefetch" href="/assets/js/237.cad6b7ea.js"><link rel="prefetch" href="/assets/js/238.c802c732.js"><link rel="prefetch" href="/assets/js/239.3a5fe17c.js"><link rel="prefetch" href="/assets/js/24.4c371769.js"><link rel="prefetch" href="/assets/js/240.27f6052d.js"><link rel="prefetch" href="/assets/js/241.a631c566.js"><link rel="prefetch" href="/assets/js/242.01736d0d.js"><link rel="prefetch" href="/assets/js/243.b1af5586.js"><link rel="prefetch" href="/assets/js/244.18016cf2.js"><link rel="prefetch" href="/assets/js/245.0626c28d.js"><link rel="prefetch" href="/assets/js/246.73f699ec.js"><link rel="prefetch" href="/assets/js/247.f444bd44.js"><link rel="prefetch" href="/assets/js/248.65a80d31.js"><link rel="prefetch" href="/assets/js/249.0dd1d0d9.js"><link rel="prefetch" href="/assets/js/25.b040b00d.js"><link rel="prefetch" href="/assets/js/250.69712e0b.js"><link rel="prefetch" href="/assets/js/251.d4d3c3e2.js"><link rel="prefetch" href="/assets/js/252.6484f155.js"><link rel="prefetch" href="/assets/js/253.410f1ed5.js"><link rel="prefetch" href="/assets/js/254.e8b85c6f.js"><link rel="prefetch" href="/assets/js/255.d2df3587.js"><link rel="prefetch" href="/assets/js/256.09bb0d0e.js"><link rel="prefetch" href="/assets/js/257.71461633.js"><link rel="prefetch" href="/assets/js/258.af2f399d.js"><link rel="prefetch" href="/assets/js/259.9ec5e83b.js"><link rel="prefetch" href="/assets/js/26.a1fb922a.js"><link rel="prefetch" href="/assets/js/260.cac8239f.js"><link rel="prefetch" href="/assets/js/261.925d41ff.js"><link rel="prefetch" href="/assets/js/262.28633c4a.js"><link rel="prefetch" href="/assets/js/263.f21c004b.js"><link rel="prefetch" href="/assets/js/264.57e4ff6c.js"><link rel="prefetch" href="/assets/js/265.c962904f.js"><link rel="prefetch" href="/assets/js/266.5d28c35b.js"><link rel="prefetch" href="/assets/js/267.966d88be.js"><link rel="prefetch" href="/assets/js/268.7f072ba9.js"><link rel="prefetch" href="/assets/js/269.8a2bbc16.js"><link rel="prefetch" href="/assets/js/27.8ae4e4fd.js"><link rel="prefetch" href="/assets/js/270.c7dbb8c2.js"><link rel="prefetch" href="/assets/js/271.fd0a8147.js"><link rel="prefetch" href="/assets/js/272.39f2833e.js"><link rel="prefetch" href="/assets/js/273.5d03fdb3.js"><link rel="prefetch" href="/assets/js/274.d7cde43a.js"><link rel="prefetch" href="/assets/js/275.2b84609e.js"><link rel="prefetch" href="/assets/js/276.2ba14d83.js"><link rel="prefetch" href="/assets/js/277.bedaa21d.js"><link rel="prefetch" href="/assets/js/278.9750200e.js"><link rel="prefetch" href="/assets/js/279.54cf5084.js"><link rel="prefetch" href="/assets/js/28.7c726cfd.js"><link rel="prefetch" href="/assets/js/280.24775da3.js"><link rel="prefetch" href="/assets/js/281.f44383db.js"><link rel="prefetch" href="/assets/js/282.5dd2530b.js"><link rel="prefetch" href="/assets/js/283.60a029cc.js"><link rel="prefetch" href="/assets/js/284.80d5c684.js"><link rel="prefetch" href="/assets/js/285.2233e644.js"><link rel="prefetch" href="/assets/js/286.2e6924e4.js"><link rel="prefetch" href="/assets/js/287.52470b25.js"><link rel="prefetch" href="/assets/js/288.0c9d41ca.js"><link rel="prefetch" href="/assets/js/289.57b35055.js"><link rel="prefetch" href="/assets/js/29.5762da80.js"><link rel="prefetch" href="/assets/js/290.3765d6a5.js"><link rel="prefetch" href="/assets/js/291.6bd15b79.js"><link rel="prefetch" href="/assets/js/292.afb5a75a.js"><link rel="prefetch" href="/assets/js/293.f5759dcb.js"><link rel="prefetch" href="/assets/js/294.2209dfe5.js"><link rel="prefetch" href="/assets/js/295.f7e224d5.js"><link rel="prefetch" href="/assets/js/296.36fde749.js"><link rel="prefetch" href="/assets/js/297.df8a1239.js"><link rel="prefetch" href="/assets/js/298.d0028860.js"><link rel="prefetch" href="/assets/js/299.f44a0e98.js"><link rel="prefetch" href="/assets/js/3.1b6e43a5.js"><link rel="prefetch" href="/assets/js/30.f7bd2da9.js"><link rel="prefetch" href="/assets/js/300.e1e1e2af.js"><link rel="prefetch" href="/assets/js/301.ac068e67.js"><link rel="prefetch" href="/assets/js/302.1e2a778b.js"><link rel="prefetch" href="/assets/js/303.32c1023d.js"><link rel="prefetch" href="/assets/js/304.2bd7d59c.js"><link rel="prefetch" href="/assets/js/305.0e0b08a3.js"><link rel="prefetch" href="/assets/js/306.48947241.js"><link rel="prefetch" href="/assets/js/307.04186968.js"><link rel="prefetch" href="/assets/js/308.b6b41f7b.js"><link rel="prefetch" href="/assets/js/309.ed01b460.js"><link rel="prefetch" href="/assets/js/31.81b4a4d2.js"><link rel="prefetch" href="/assets/js/310.61ab2756.js"><link rel="prefetch" href="/assets/js/311.dfa83b75.js"><link rel="prefetch" href="/assets/js/312.21c9fcf2.js"><link rel="prefetch" href="/assets/js/313.9c7bdcf7.js"><link rel="prefetch" href="/assets/js/314.444459f4.js"><link rel="prefetch" href="/assets/js/315.01c2dddd.js"><link rel="prefetch" href="/assets/js/316.fa19412e.js"><link rel="prefetch" href="/assets/js/317.b8e81823.js"><link rel="prefetch" href="/assets/js/318.a76c19a2.js"><link rel="prefetch" href="/assets/js/319.b6d393e9.js"><link rel="prefetch" href="/assets/js/32.d9074bf8.js"><link rel="prefetch" href="/assets/js/320.b9b7d53d.js"><link rel="prefetch" href="/assets/js/321.377dc9df.js"><link rel="prefetch" href="/assets/js/322.5414100c.js"><link rel="prefetch" href="/assets/js/323.0edddb0c.js"><link rel="prefetch" href="/assets/js/324.a3c19125.js"><link rel="prefetch" href="/assets/js/325.0a931352.js"><link rel="prefetch" href="/assets/js/326.99cd4779.js"><link rel="prefetch" href="/assets/js/327.aa0bbc95.js"><link rel="prefetch" href="/assets/js/328.8d936413.js"><link rel="prefetch" href="/assets/js/329.86331300.js"><link rel="prefetch" href="/assets/js/33.61cbe880.js"><link rel="prefetch" href="/assets/js/330.2f949c81.js"><link rel="prefetch" href="/assets/js/331.27c8897b.js"><link rel="prefetch" href="/assets/js/332.2a06265f.js"><link rel="prefetch" href="/assets/js/333.5380694f.js"><link rel="prefetch" href="/assets/js/334.a4fc88c7.js"><link rel="prefetch" href="/assets/js/335.d24aa360.js"><link rel="prefetch" href="/assets/js/336.e6c27799.js"><link rel="prefetch" href="/assets/js/337.7068bfa9.js"><link rel="prefetch" href="/assets/js/338.05129acf.js"><link rel="prefetch" href="/assets/js/339.32a155e4.js"><link rel="prefetch" href="/assets/js/34.458856b1.js"><link rel="prefetch" href="/assets/js/340.79f4160c.js"><link rel="prefetch" href="/assets/js/341.1845d39d.js"><link rel="prefetch" href="/assets/js/342.e9025266.js"><link rel="prefetch" href="/assets/js/343.022762e6.js"><link rel="prefetch" href="/assets/js/344.5f6ede26.js"><link rel="prefetch" href="/assets/js/345.0f09d3e9.js"><link rel="prefetch" href="/assets/js/346.baf57bd3.js"><link rel="prefetch" href="/assets/js/347.fca5ad32.js"><link rel="prefetch" href="/assets/js/348.ee72d1c4.js"><link rel="prefetch" href="/assets/js/349.3d1973a7.js"><link rel="prefetch" href="/assets/js/35.bd72afbd.js"><link rel="prefetch" href="/assets/js/350.6c10a97f.js"><link rel="prefetch" href="/assets/js/351.2b4fcad2.js"><link rel="prefetch" href="/assets/js/352.cc2e2e46.js"><link rel="prefetch" href="/assets/js/353.93baf91c.js"><link rel="prefetch" href="/assets/js/354.ce9d0e4c.js"><link rel="prefetch" href="/assets/js/355.110b2119.js"><link rel="prefetch" href="/assets/js/356.31c1cb3f.js"><link rel="prefetch" href="/assets/js/357.fc56933d.js"><link rel="prefetch" href="/assets/js/358.3d6f0995.js"><link rel="prefetch" href="/assets/js/359.e42fb771.js"><link rel="prefetch" href="/assets/js/36.51ff5da4.js"><link rel="prefetch" href="/assets/js/360.b23f20a6.js"><link rel="prefetch" href="/assets/js/361.d40a5970.js"><link rel="prefetch" href="/assets/js/362.5526289b.js"><link rel="prefetch" href="/assets/js/363.57de68f3.js"><link rel="prefetch" href="/assets/js/364.be1cb110.js"><link rel="prefetch" href="/assets/js/365.61d49f0a.js"><link rel="prefetch" href="/assets/js/366.b507225c.js"><link rel="prefetch" href="/assets/js/367.7b1436ad.js"><link rel="prefetch" href="/assets/js/368.dcd60637.js"><link rel="prefetch" href="/assets/js/369.51c46392.js"><link rel="prefetch" href="/assets/js/37.4d7470cc.js"><link rel="prefetch" href="/assets/js/370.79f0015e.js"><link rel="prefetch" href="/assets/js/371.d8c48ef6.js"><link rel="prefetch" href="/assets/js/372.3ccfa0e9.js"><link rel="prefetch" href="/assets/js/373.6ff5c143.js"><link rel="prefetch" href="/assets/js/374.f4fcf914.js"><link rel="prefetch" href="/assets/js/375.d24d77a1.js"><link rel="prefetch" href="/assets/js/376.46fa8c82.js"><link rel="prefetch" href="/assets/js/377.dc0360fd.js"><link rel="prefetch" href="/assets/js/38.b792089b.js"><link rel="prefetch" href="/assets/js/39.65ad4770.js"><link rel="prefetch" href="/assets/js/4.86cba761.js"><link rel="prefetch" href="/assets/js/40.8b58385f.js"><link rel="prefetch" href="/assets/js/41.398e86ae.js"><link rel="prefetch" href="/assets/js/42.789f1388.js"><link rel="prefetch" href="/assets/js/43.05f9d13d.js"><link rel="prefetch" href="/assets/js/44.c2b40548.js"><link rel="prefetch" href="/assets/js/45.df48e9a2.js"><link rel="prefetch" href="/assets/js/46.b83749fb.js"><link rel="prefetch" href="/assets/js/47.7ef7d498.js"><link rel="prefetch" href="/assets/js/48.228e3df9.js"><link rel="prefetch" href="/assets/js/49.fda0dc0b.js"><link rel="prefetch" href="/assets/js/5.3a0ea465.js"><link rel="prefetch" href="/assets/js/50.d9cf5581.js"><link rel="prefetch" href="/assets/js/51.3096a574.js"><link rel="prefetch" href="/assets/js/52.479127e5.js"><link rel="prefetch" href="/assets/js/53.5e0b1963.js"><link rel="prefetch" href="/assets/js/54.59740785.js"><link rel="prefetch" href="/assets/js/55.3b7f709a.js"><link rel="prefetch" href="/assets/js/56.54492258.js"><link rel="prefetch" href="/assets/js/57.35db8f10.js"><link rel="prefetch" href="/assets/js/59.63dfef23.js"><link rel="prefetch" href="/assets/js/6.5a97029d.js"><link rel="prefetch" href="/assets/js/60.fdf12a20.js"><link rel="prefetch" href="/assets/js/61.fe3f97d3.js"><link rel="prefetch" href="/assets/js/62.f1b0daf7.js"><link rel="prefetch" href="/assets/js/63.93837b5d.js"><link rel="prefetch" href="/assets/js/64.97a1fe26.js"><link rel="prefetch" href="/assets/js/65.70f35686.js"><link rel="prefetch" href="/assets/js/66.3ba3c686.js"><link rel="prefetch" href="/assets/js/67.14cef3f2.js"><link rel="prefetch" href="/assets/js/68.e8a147f5.js"><link rel="prefetch" href="/assets/js/69.24e88bd2.js"><link rel="prefetch" href="/assets/js/7.ce6c36f3.js"><link rel="prefetch" href="/assets/js/70.15818cd2.js"><link rel="prefetch" href="/assets/js/71.119594cc.js"><link rel="prefetch" href="/assets/js/72.9fcbbf86.js"><link rel="prefetch" href="/assets/js/73.b82c6339.js"><link rel="prefetch" href="/assets/js/74.32848a73.js"><link rel="prefetch" href="/assets/js/75.6efef423.js"><link rel="prefetch" href="/assets/js/76.17ea6bee.js"><link rel="prefetch" href="/assets/js/77.220ac10b.js"><link rel="prefetch" href="/assets/js/78.a880b44d.js"><link rel="prefetch" href="/assets/js/79.217ab01c.js"><link rel="prefetch" href="/assets/js/8.cbd97eba.js"><link rel="prefetch" href="/assets/js/80.2e717400.js"><link rel="prefetch" href="/assets/js/81.b7277c4e.js"><link rel="prefetch" href="/assets/js/82.8e22a60c.js"><link rel="prefetch" href="/assets/js/83.c39494a6.js"><link rel="prefetch" href="/assets/js/84.e379d0cd.js"><link rel="prefetch" href="/assets/js/85.3f7d9716.js"><link rel="prefetch" href="/assets/js/86.a7c0bd99.js"><link rel="prefetch" href="/assets/js/87.eb9b0263.js"><link rel="prefetch" href="/assets/js/88.32d31cd7.js"><link rel="prefetch" href="/assets/js/89.cb0eb0c6.js"><link rel="prefetch" href="/assets/js/9.e79b9220.js"><link rel="prefetch" href="/assets/js/90.2aa9f60f.js"><link rel="prefetch" href="/assets/js/91.979af91d.js"><link rel="prefetch" href="/assets/js/92.ecca824d.js"><link rel="prefetch" href="/assets/js/93.70a3d5ac.js"><link rel="prefetch" href="/assets/js/94.c163ecdc.js"><link rel="prefetch" href="/assets/js/95.d5eb2ea5.js"><link rel="prefetch" href="/assets/js/96.d596f924.js"><link rel="prefetch" href="/assets/js/97.fde076d3.js"><link rel="prefetch" href="/assets/js/98.1189bd76.js"><link rel="prefetch" href="/assets/js/99.9e004fea.js">
    <link rel="stylesheet" href="/assets/css/0.styles.55beba5e.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu"><header class="navbar blur"><div title="目录" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/img/logo.png" alt="洋仔的博客" class="logo"> <span class="site-name can-hide">洋仔的博客</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="个人心法" class="dropdown-title"><a href="/person/" class="link-title">个人心法</a> <span class="title" style="display:none;">个人心法</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>个人心法总结</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/pages/fe3f91/" class="nav-link">价值心法</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="技术" class="dropdown-title"><a href="/technology/" class="link-title">技术</a> <span class="title" style="display:none;">技术</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/9a7ee40fc232253e/" class="nav-link">技术文档</a></li><li class="dropdown-item"><!----> <a href="/pages/4c778760be26d8b3/" class="nav-link">GitHub技巧</a></li><li class="dropdown-item"><!----> <a href="/pages/117708e0af7f0bd9/" class="nav-link">Nodejs</a></li><li class="dropdown-item"><!----> <a href="/pages/41f87d890d0a02af/" class="nav-link">博客搭建</a></li><li class="dropdown-item"><!----> <a href="/pages/d13cac/" class="nav-link">iOS基础知识</a></li><li class="dropdown-item"><!----> <a href="/pages/8309a5b876fc95e3/" class="nav-link">前端</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="其他" class="dropdown-title"><a href="/more/" class="link-title">其他</a> <span class="title" style="display:none;">其他</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/f2a556/" class="nav-link">学习</a></li><li class="dropdown-item"><!----> <a href="/pages/aea6571b7a8bae86/" class="nav-link">面试</a></li><li class="dropdown-item"><!----> <a href="/pages/2d615df9a36a98ed/" class="nav-link">心情杂货</a></li><li class="dropdown-item"><!----> <a href="/pages/baaa02/" class="nav-link">实用技巧</a></li><li class="dropdown-item"><!----> <a href="/pages/15d3d8/" class="nav-link">投资体系</a></li><li class="dropdown-item"><!----> <a href="/pages/4db018/" class="nav-link">毛选</a></li><li class="dropdown-item"><!----> <a href="/friends/" class="nav-link">友情链接</a></li></ul></div></div><div class="nav-item"><a href="/about/" class="nav-link">关于</a></div><div class="nav-item"><a href="/pages/beb6c0bd8a66cea6/" class="nav-link">收藏</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/archives/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">归档</a></li></ul></div></div> <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><div class="blogger"><img src="https://cdn.jsdelivr.net/gh/214070779/publicPicture@master/pingtou.5ytkqlpmd940.webp"> <div class="blogger-info"><h3>洋仔</h3> <span>奋斗的小青年</span></div></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="个人心法" class="dropdown-title"><a href="/person/" class="link-title">个人心法</a> <span class="title" style="display:none;">个人心法</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>个人心法总结</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/pages/fe3f91/" class="nav-link">价值心法</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="技术" class="dropdown-title"><a href="/technology/" class="link-title">技术</a> <span class="title" style="display:none;">技术</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/9a7ee40fc232253e/" class="nav-link">技术文档</a></li><li class="dropdown-item"><!----> <a href="/pages/4c778760be26d8b3/" class="nav-link">GitHub技巧</a></li><li class="dropdown-item"><!----> <a href="/pages/117708e0af7f0bd9/" class="nav-link">Nodejs</a></li><li class="dropdown-item"><!----> <a href="/pages/41f87d890d0a02af/" class="nav-link">博客搭建</a></li><li class="dropdown-item"><!----> <a href="/pages/d13cac/" class="nav-link">iOS基础知识</a></li><li class="dropdown-item"><!----> <a href="/pages/8309a5b876fc95e3/" class="nav-link">前端</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="其他" class="dropdown-title"><a href="/more/" class="link-title">其他</a> <span class="title" style="display:none;">其他</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/f2a556/" class="nav-link">学习</a></li><li class="dropdown-item"><!----> <a href="/pages/aea6571b7a8bae86/" class="nav-link">面试</a></li><li class="dropdown-item"><!----> <a href="/pages/2d615df9a36a98ed/" class="nav-link">心情杂货</a></li><li class="dropdown-item"><!----> <a href="/pages/baaa02/" class="nav-link">实用技巧</a></li><li class="dropdown-item"><!----> <a href="/pages/15d3d8/" class="nav-link">投资体系</a></li><li class="dropdown-item"><!----> <a href="/pages/4db018/" class="nav-link">毛选</a></li><li class="dropdown-item"><!----> <a href="/friends/" class="nav-link">友情链接</a></li></ul></div></div><div class="nav-item"><a href="/about/" class="nav-link">关于</a></div><div class="nav-item"><a href="/pages/beb6c0bd8a66cea6/" class="nav-link">收藏</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/archives/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">归档</a></li></ul></div></div> <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>技术文档</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>GitHub技巧</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Nodejs</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>博客搭建</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>iOS基础知识</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>iOS底层相关</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>Runloop系列</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>Runtime系列</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>内存管理系列</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>Block系列</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>线程系列</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>KVC跟KVO系列以及通知中心</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>UI系列</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading open"><span>离屏渲染系列</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/63687b/" aria-current="page" class="active sidebar-link">离屏渲染</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level2"><a href="/pages/63687b/#为什么要理解离屏渲染" class="sidebar-link">为什么要理解离屏渲染</a></li><li class="sidebar-sub-header level2"><a href="/pages/63687b/#显示器显示原理" class="sidebar-link">显示器显示原理</a></li><li class="sidebar-sub-header level2"><a href="/pages/63687b/#屏幕成像过程" class="sidebar-link">屏幕成像过程</a></li><li class="sidebar-sub-header level2"><a href="/pages/63687b/#屏幕撕裂的原因" class="sidebar-link">屏幕撕裂的原因</a></li><li class="sidebar-sub-header level2"><a href="/pages/63687b/#苹果官方的解决方案" class="sidebar-link">苹果官方的解决方案</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/63687b/#掉帧" class="sidebar-link">掉帧</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/63687b/#ios的渲染" class="sidebar-link">iOS的渲染</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/63687b/#ios中渲染框架总结" class="sidebar-link">iOS中渲染框架总结</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/63687b/#ios离屏渲染-在屏渲染" class="sidebar-link">iOS离屏渲染 &amp;&amp;在屏渲染</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/63687b/#正常渲染流程" class="sidebar-link">正常渲染流程</a></li><li class="sidebar-sub-header level3"><a href="/pages/63687b/#离屏渲染流程" class="sidebar-link">离屏渲染流程</a></li><li class="sidebar-sub-header level3"><a href="/pages/63687b/#离屏渲染的另一个原因-光栅化" class="sidebar-link">离屏渲染的另一个原因：光栅化</a></li><li class="sidebar-sub-header level3"><a href="/pages/63687b/#圆角中离屏渲染的触发时机" class="sidebar-link">圆角中离屏渲染的触发时机</a></li><li class="sidebar-sub-header level3"><a href="/pages/63687b/#圆角设置不生效问题" class="sidebar-link">圆角设置不生效问题！</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/63687b/#如何减少离屏渲染" class="sidebar-link">如何减少离屏渲染</a></li><li class="sidebar-sub-header level2"><a href="/pages/63687b/#ios中图像显示原理-图像加载过程" class="sidebar-link">iOS中图像显示原理 == 图像加载过程</a></li><li class="sidebar-sub-header level2"><a href="/pages/63687b/#图片的解压缩" class="sidebar-link">图片的解压缩</a></li><li class="sidebar-sub-header level2"><a href="/pages/63687b/#离屏渲染为何性能消耗高" class="sidebar-link">离屏渲染为何性能消耗高</a></li><li class="sidebar-sub-header level2"><a href="/pages/63687b/#卡顿发生的原因" class="sidebar-link">卡顿发生的原因</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/63687b/#监控卡顿的指标-fps-帧率" class="sidebar-link">监控卡顿的指标: FPS（帧率）</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/63687b/#问题汇总" class="sidebar-link">问题汇总</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/63687b/#对视图的性能优化有一些了解-你可不可以先说下-图像显示相关的原理" class="sidebar-link">对视图的性能优化有一些了解，你可不可以先说下 图像显示相关的原理</a></li><li class="sidebar-sub-header level3"><a href="/pages/63687b/#既然了解图像显示的原理-那你知道ios视图卡顿掉帧的原因吗" class="sidebar-link">既然了解图像显示的原理，那你知道IOS视图卡顿掉帧的原因吗？</a></li><li class="sidebar-sub-header level3"><a href="/pages/63687b/#那你知道如何监控界面的卡顿吗" class="sidebar-link">那你知道如何监控界面的卡顿吗</a></li><li class="sidebar-sub-header level3"><a href="/pages/63687b/#如何优化掉帧卡顿" class="sidebar-link">如何优化掉帧卡顿</a></li></ul></li></ul></li><li><a href="/pages/a97536/" class="sidebar-link">图片相关的问题</a></li></ul></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>组件化系列跟架构</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>OC跟webview交互系列</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>持久化系列</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>APP编译系列</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>APP性能优化系列</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>cocoapods系列</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>swift系列</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>Git系列</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>网络相关</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>三方库系列</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>系统原理</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>总结系列</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>算法系列</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>数据结构系列</span> <span class="arrow right"></span></p> <!----></section></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>前端</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <div><main class="page"><div class="theme-vdoing-wrapper bg-style-6"><div class="articleInfo-wrap" data-v-06225672><div class="articleInfo" data-v-06225672><ul class="breadcrumbs" data-v-06225672><li data-v-06225672><a href="/" title="首页" class="iconfont icon-home router-link-active" data-v-06225672></a></li> <li data-v-06225672><a href="/ui/#技术" data-v-06225672>技术</a></li><li data-v-06225672><a href="/ui/#iOS基础知识" data-v-06225672>iOS基础知识</a></li><li data-v-06225672><a href="/ui/#离屏渲染系列" data-v-06225672>离屏渲染系列</a></li></ul> <div class="info" data-v-06225672><div title="作者" class="author iconfont icon-touxiang" data-v-06225672><a href="https://github.com/214070779" target="_blank" title="作者" class="beLink" data-v-06225672>洋仔</a></div> <div title="创建时间" class="date iconfont icon-riqi" data-v-06225672><a href="javascript:;" data-v-06225672>2023-08-11</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-title">目录</div> <div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABKFJREFUSA3tVl1oFVcQnrMbrak3QUgkya1akpJYcrUtIqW1JvFBE9LiQ5v6JmJpolbMg32rVrhgoYK0QiMY6i9Y6EMaW5D+xFJaTYItIuK2Kr3+BJNwkxBj05sQY3b3nM6cs2dv9t7NT/vQJw/sndk5M/PNzJkzewGerP+pAmy+ON8lLzUJgA8ZYxYIYZmGYRnctDaWvJJAmTtfP1pvXsBCCPP8QFcCaRkZYACgDZFO4stNIcBCajEOlmmC9XpJ9bAGCaPaPmzPl32dvLSVu3BWCTQs0XQQ6g0DYgwLIoAZbBCdW/i+781o1VVlm/410mw4h06Y7bIPHNyWDyL4FHkX03Q8SrzNhZTZriieckWt7cL6MM85YcLpsi/7O9/iXFT6MswI0DmmpkSaJ0qLxFIm3+i1THHB3zmBH3PYx9CcykcLOeQVVa7QtdxTgQgEleX2AjHYfwA+2ddV77ruGoJUbhGDI09YSNXyMpUt5ylOzxgbUmtOp7NmbNt8v3arjTBfYELmLUV+M+nSawNNAUqpT3ClJWg5I3BLT+cGW/DXNGCa6tx1aakCGEigArTn4TDIPdrXXYKCZNrHLMCOEPvHBlLQ99s9eHB7EB6NTki73CVPQ2F5MSx/uRQixfmq7rK0wYD8w8E905bnPDfwoWs/rfv93NWN/ZfvwsLIU7A09gxECyISeGJkHAau98L97tuw7NXnoPyNF8FcYGLGKsOs0mN3OEyec9esGW/ZEl945dTP34wlR2FZVQWU1q0Cw8Tr7p+hgLLNL0FPxx/Q35mA8aEUrH6nCgwEl0tn7wUiZYJnNRh6DK4UH/k0lfyrsBKdPVv/AriGIQcEDQZ65LBAGe2Rzui9Ybjz7XUppz1/uKBbyVPGkN3ZAeC6hr0x7Nr38N5+EqkoOm17xpoqR9ohQF55ERSvr4Dkr3chNfC3DMzGJlNBElW8w9nsGQvhNGIzDkXzCg8cLK951xHsFBlTJspJNi3ZFIMF2AeDV3q8DNOB+YHi6QTrChDIWDBRi5U5f+ZMfJLu3ccrqxtdxk4SKH336LFxSmkqefwU5T8fhdSdQf9IVKD6aNiwI/hnmcAZ91isYMJIaCUCx9W098+LgruikeTqzqqxKPUwqJyCPJiyemVVZBOijDGjD38Os0jOiSPL1z3SPjXNANbiNPXAdzTfukjjuknNBbyz3nwgTd3AVFqUJ5hpHlq9MveLnWwttUfoygBmvVjuikxND3znrhsELnZk7k+OjIGxeNEkomyLVta0xxn+HZhjBc4YZ/AFjHjz9u3xRZl2BN4aq9nFwWh16IrQ1aHHEd3j1+4/dB9OtH4e29A2H1DyHQRmOSfQZ1Fy7MHBTGB6J/Djq6p3OxyO2cB+4Car7v/o3GXgfAkj23+x9ID1Teoamo/SXcbvSf2PX7Vc8DdCmE1vN9di+32P9/5YR3vLnhCVGUWBjEkr3yh4H8v9CzmsbdhzOKzsJKM90iFdaTMjRPhGVsakRvOaRidljo6H6G7j+ctrJpsP+4COhDIl0La2+FS4+5mlocBaXY5QnGZysIBYoeSsl5qQzrSj/cgNrfuEzlWBfwA+EjrZyWUvpAAAAABJRU5ErkJggg==">离屏渲染<!----></h1> <!----> <div class="theme-vdoing-content content__default"><h2 id="为什么要理解离屏渲染"><a href="#为什么要理解离屏渲染" class="header-anchor">#</a> 为什么要理解离屏渲染</h2> <div class="custom-block warning"><p class="custom-block-title">注意</p> <p>离屏渲染（Offscreen rendering）对iOS开发者来说不是一个陌生的东西，项目中或多或少都会存在离屏渲染，也是面试中经常考察的知识点。一般来说，大多数人都能知道设置圆角、mask、阴影等会触发离屏渲染，但我们深入的探究一下，大家能够很清楚的知道下面几个问题吗？</p> <p>离屏渲染是在哪一步发生的吗？</p> <p>离屏渲染产生的原因是什么呢？</p> <p>设置圆角一定会触发离屏渲染吗？</p> <p>离屏渲染既然会影响性能我们为什么还要使用呢？</p> <p>优化方案又有那些？</p></div> <h2 id="显示器显示原理"><a href="#显示器显示原理" class="header-anchor">#</a> 显示器显示原理</h2> <p>以过去的CRT显示原理为例：
介绍屏幕图像显示的原理，需要先从 CRT 显示器原理说起，如下图所示
<img src="https://cdn.staticaly.com/gh/214070779/picx-images-hosting@master/20230813/%E7%A4%BA%E4%BE%8B.3spcghgpms80.webp" alt="CRT原理图"></p> <ul><li><p>CRT 的电子枪从上到下逐行扫描，扫描完成后显示器就呈现一帧画面。
然后电子枪回到初始位置进行下一次扫描。</p></li> <li><p>为了同步显示器的显示过程和系统的视频控制器，显示器会用硬件时钟产生一系列的定时信号。当电子枪换行进行扫描时，显示器会发出一个水平同步信号（horizonal synchronization），简称 HSync；</p></li> <li><p>而当一帧画面绘制完成后，电子枪回复到原位，准备画下一帧前，显示器会发出一个垂直同步信号（vertical synchronization），简称 VSync。</p></li> <li><p>显示器通常以固定频率进行刷新，这个刷新率就是 VSync 信号产生的频率 又称帧率。</p></li> <li><p>虽然现在的显示器基本都是液晶显示屏了，但其原理基本一致。</p></li></ul> <h2 id="屏幕成像过程"><a href="#屏幕成像过程" class="header-anchor">#</a> 屏幕成像过程</h2> <p><img src="https://cdn.staticaly.com/gh/214070779/picx-images-hosting@master/20230813/Screenshot-2023-08-13-at-8.14.08-PM.1mk89ddieda8.webp" alt="Screenshot-2023-08-13-at-8"></p> <ul><li>将需要显示的图像，经由GPU渲染</li> <li>将渲染后的结果，存储到帧缓存区，帧缓存区中存储的格式是位图</li> <li>由视屏控制器从帧缓存区中读取位图，交由显示器，从左上角逐行扫描进行显示</li></ul> <h2 id="屏幕撕裂的原因"><a href="#屏幕撕裂的原因" class="header-anchor">#</a> 屏幕撕裂的原因</h2> <ul><li>在屏幕显示图形图像的过程中，是不断从帧缓存区获取一帧一帧数据进行显示的，</li> <li>然后在渲染的过程中，帧缓存区中仍是旧的数据，屏幕拿到旧的数据去进行显示，</li> <li>在旧的数据没有读取完时 ，新的一帧数据处理好了，放入了缓存区，这时就会导致屏幕另一部分的显示是获取的线数据，从而导致屏幕上呈现图片不匹配，人物、景象等错位显示的情况。</li></ul> <p><img src="https://cdn.staticaly.com/gh/214070779/picx-images-hosting@master/20230813/Screenshot-2023-08-13-at-8.18.08-PM.4asvrjtccs20.webp" alt="Screenshot-2023-08-13-at-8"></p> <p>垂直同步：是指给帧缓冲加锁，当电子光束扫描的过程中，只有扫描完成了才会读取下一帧的数据，而不是只读取一部分</p> <p>双缓冲区：采用两个帧缓冲区用途GPU处理结果的存储，当屏幕显示其中一个缓存区内容时，另一个缓冲区继续等待下一个缓冲结果，两个缓冲区依次进行交替</p> <h2 id="苹果官方的解决方案"><a href="#苹果官方的解决方案" class="header-anchor">#</a> 苹果官方的解决方案</h2> <p>苹果官方针对屏幕撕裂现象，目前一直采用的是 垂直同步+双缓存，该方案是强制要求同步，且是以掉帧为代价的。</p> <p>以下是垂直同步+双缓存的一个图解过程，如有描述错误的地方，欢迎留言指出</p> <p><img src="https://cdn.staticaly.com/gh/214070779/picx-images-hosting@master/20230813/%E5%A5%BD%E5%9B%BE.1ydldrefnnq8.webp" alt="好图"></p> <p>垂直同步：是指给帧缓冲加锁，当电子光束扫描的过程中，只有扫描完成了才会读取下一帧的数据，而不是只读取一部分</p> <p>双缓冲区：采用两个帧缓冲区用途GPU处理结果的存储，当屏幕显示其中一个缓存区内容时，另一个缓冲区继续等待下一个缓冲结果，两个缓冲区依次进行交替</p> <h3 id="掉帧"><a href="#掉帧" class="header-anchor">#</a> 掉帧</h3> <p>采用苹果的双缓冲区方案后，又会出现新的问题，掉帧。
什么是掉帧？简单来说就是 屏幕重复显示同一帧数据的情况就是掉帧</p> <p>如图所示：当前屏幕显示的是A，在收到垂直信号后，CPU和GPU处理的B还没有准备好，此时，屏幕显示的仍然是A</p> <p><img src="https://cdn.staticaly.com/gh/214070779/picx-images-hosting@master/20230813/%E6%8E%89%E5%B8%A7.6sg1fz82du40.webp" alt="掉帧"></p> <p>针对掉帧情况，我们可以在苹果方案的基础上进行优化，即采用三缓存区，意味着，在屏幕显示时，后面还准备了3个数据用于显示。</p> <h2 id="ios的渲染"><a href="#ios的渲染" class="header-anchor">#</a> iOS的渲染</h2> <p>在iOS中渲染的整体流程如下所示
<img src="https://cdn.staticaly.com/gh/214070779/picx-images-hosting@master/20230813/Screenshot-2023-08-13-at-8.26.56-PM.xo0d2mhl9hs.webp" alt="Screenshot-2023-08-13-at-8"></p> <ul><li>App通过调用CoreGraphics、CoreAnimation、CoreImage等框架的接口触发图形渲染操作</li> <li>CoreGraphics、CoreAnimation、CoreImage等框架将渲染交由OpenGL ES，由OpenGL ES来驱动GPU做渲染，最后显示到屏幕上</li> <li>由于OpenGL ES 是跨平台的，所以在他的实现中，是不能有任何窗口相关的代码，而是让各自的平台为OpenGL ES提供载体。在ios中，如果需要使用OpenGL ES，就是通过CoreAnimation提供窗口，让App可以去调用。</li></ul> <h3 id="ios中渲染框架总结"><a href="#ios中渲染框架总结" class="header-anchor">#</a> iOS中渲染框架总结</h3> <p><img src="https://cdn.staticaly.com/gh/214070779/picx-images-hosting@master/20230813/%E6%B8%B2%E6%9F%93%E6%80%BB%E7%BB%93.1f6o6yf3ny9s.webp" alt="渲染总结"></p> <h2 id="ios离屏渲染-在屏渲染"><a href="#ios离屏渲染-在屏渲染" class="header-anchor">#</a> iOS离屏渲染 &amp;&amp;在屏渲染</h2> <p>屏幕上最终显示的数据有两种加载流程</p> <p>正常渲染加载流程</p> <p>离屏渲染加载流程</p> <p><img src="https://cdn.staticaly.com/gh/214070779/picx-images-hosting@master/20230813/Screenshot-2023-08-13-at-8.33.13-PM.5u6vkhhvmq40.webp" alt="Screenshot-2023-08-13-at-8"></p> <p>从图上看，他们之间的区别就是离屏渲染比正常渲染多了一个离屏缓冲区，这个缓冲区的作用是什么呢？下面来仔细说说
首先，说说正常渲染流程</p> <h3 id="正常渲染流程"><a href="#正常渲染流程" class="header-anchor">#</a> 正常渲染流程</h3> <p>如果是不触发离屏渲染的正常渲染，苹果在绘制完最底层的图层，从帧缓冲区显示到屏幕上之后，就丢弃了，并不会保存起来，再画第二层，也是如此，显示完了就丢弃，从而节省了空间。
<img src="https://cdn.staticaly.com/gh/214070779/picx-images-hosting@master/20230813/8488628-57584ba10c3fbf7a.7bn26e57mmk0.webp" alt="8488628-57584ba10c3fbf7a"></p> <p>这张图演示的是著名的油画算法。指的是先绘制远的部分，再绘制近的部分。我们图层的渲染也是同理，系统会先绘制最底层的图层，再往上一层层的绘制，最后形成了图层树，苹果建议开发者在建立UI的时候，图层树不要太复杂，层级不要太多，不然也是会有性能影响。
如果是不触发离屏渲染的正常渲染，苹果在绘制完最底层的图层，从帧缓冲区显示到屏幕上之后，就丢弃了，并不会保存起来，再画第二层，也是如此，显示完了就丢弃，从而节省了空间。</p> <p><img src="https://cdn.staticaly.com/gh/214070779/picx-images-hosting@master/20230813/Screenshot-2023-08-13-at-9.24.33-PM.71i1yj8pmh00.webp" alt="Screenshot-2023-08-13-at-9"></p> <h3 id="离屏渲染流程"><a href="#离屏渲染流程" class="header-anchor">#</a> 离屏渲染流程</h3> <p>如果对一个多图层图像进行圆角处理，就需要对所有图层进行圆角（包括内容contents），如果按照正常渲染，一层用完就丢弃，这样就达不到显示的效果。这时候就需要开辟一个离屏缓冲区去保存这些图层，等到所有图层都做了圆角处理，就把它们从离屏缓冲区里取出来进行合并显示。</p> <p><img src="https://cdn.staticaly.com/gh/214070779/picx-images-hosting@master/20230813/%E7%A6%BB%E5%B1%8F%E6%B8%B2%E6%9F%93.7e6tub1bczw0.webp" alt="离屏渲染"></p> <p>说白了，离屏缓存区就是一个临时的缓冲区，用来存放在后续操作使用，但目前并不使用的数据。</p> <p>离屏渲染再给我们带来方便的同时，也带来了严重的性能问题。由于离屏渲染中的离屏缓冲区，是额外开辟的一个存储空间，当它将数据转存到Frame Buffer时，也是需要耗费时间的，所以在转存的过程中，仍有掉帧的可能。
离屏缓冲区的空间并不是无限大的， 它是有上限的，最大只能是屏幕的2.5倍
那为什么我们明知有性能问题时，还是要使用离屏渲染呢？</p> <p>可以处理一些特殊的效果，这种效果并不能一次就完成，需要使用离屏缓冲区来保存中间状态，不得不使用离屏渲染，这种情况下的离屏渲染是系统自动触发的，例如经常使用的圆角、阴影、高斯模糊、光栅化等
可以提升渲染的效率，如果一个效果是多次实现的，可以提前渲染，保存到离屏缓冲区，以达到复用的目的。这种情况是需要开发者手动触发的。</p> <h3 id="离屏渲染的另一个原因-光栅化"><a href="#离屏渲染的另一个原因-光栅化" class="header-anchor">#</a> 离屏渲染的另一个原因：光栅化</h3> <div class="custom-block tip"><p class="custom-block-title">提示</p> <p>When the value of this property is YES, the layer is rendered as a bitmap in its local coordinate space and then composited to the destination with any other content.</p></div> <p>当我们开启光栅化时，会将layer渲染成位图保存在缓存中，这样在下次使用时，就可以直接复用，提高效率。
针对光栅化的使用，有以下几个建议：</p> <ul><li><p>如果layer不是静态，需要被频繁修改，比如处于动画中、size修改、tableView、collectionView视图中，那么开启光栅化反而影响了效率；</p></li> <li><p>离屏渲染缓存内容有时间限制，缓存的内容如果100ms内没有被使用，那么它就会丢弃，无法进行复用；</p></li> <li><p>离屏渲染的缓存空间有限，大小相当于屏幕像素点的2.5倍，超过的话也会失效，无法进行复用了；</p></li></ul> <h3 id="圆角中离屏渲染的触发时机"><a href="#圆角中离屏渲染的触发时机" class="header-anchor">#</a> 圆角中离屏渲染的触发时机</h3> <p>在讲圆角之前，首先说明下CALayer的构成，如图所示，它是由backgroundColor、contents、borderWidth&amp;borderColor构成的。跟我们即将解释的圆角触发离屏渲染息息相关。</p> <p><img src="https://cdn.staticaly.com/gh/214070779/picx-images-hosting@master/20230813/Screenshot-2023-08-13-at-9.28.15-PM.2y221q36vxm0.webp" alt="Screenshot-2023-08-13-at-9"></p> <h3 id="圆角设置不生效问题"><a href="#圆角设置不生效问题" class="header-anchor">#</a> 圆角设置不生效问题！</h3> <p>在平常写代码时，比如UIButton设置圆角，当设置好按钮的image、cornerRadius、borderWidth、borderColor等属性后，运行发现并没有实现我们想要的效果</p> <div class="language-Object-c line-numbers-mode"><pre class="language-text"><code>  let btn0 = UIButton(type: .custom)
  btn0.frame = CGRect(x: 100, y: 60, width: 100, height: 100)
  //设置圆角
  btn0.layer.cornerRadius = 50
  //设置border宽度和颜色
  btn0.layer.borderWidth = 2
  btn0.layer.borderColor = UIColor.red.cgColor
  self.view.addSubview(btn0)
  //设置背景图片
  btn0.setImage(UIImage(named: &quot;mouse&quot;), for: .normal)
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>此时的效果就是这样的，可以发现，我们设置的按钮图片还是方方正正的</p> <p><img src="https://cdn.staticaly.com/gh/214070779/picx-images-hosting@master/20230813/Screenshot-2023-08-13-at-9.30.11-PM.7i0vim4dubs0.webp" alt="Screenshot-2023-08-13-at-9"></p> <p>针对上面的这个问题，我相信99%的人都能信手拈来，知道必须要设置masksToBounds为 true，才会得到我们想要的效果。解决的方法很简单，但原理是大部人都没有去仔细研究的。</p> <p>下面是苹果官方文档针对圆角设置的一些说明</p> <p><img src="https://cdn.staticaly.com/gh/214070779/picx-images-hosting@master/20230813/%E8%8B%B9%E6%9E%9C%E5%AE%98%E7%BD%91.zeqc887d1nk.webp" alt="苹果官网"></p> <p>官方文档告诉我们，设置cornerRadius只会对CALayer中的backgroundColor 和 boder设置圆角，不会设置contents的圆角，如果contents需要设置圆角，需要同时将maskToBounds / clipsToBounds设置为true。</p> <p>所以我们可以理解为圆角不生效的根本原因是没有对contents设置圆角，而按钮设置的image是放在contents里面的，所以看到的界面上的就是image没有进行圆角裁剪。</p> <p>下面我们通过几段代码来说明 圆角设置中什么时候会离屏渲染触发
首先，需要打开模拟器的离屏渲染颜色标记</p> <p><img src="https://cdn.staticaly.com/gh/214070779/picx-images-hosting@master/20230813/Screenshot-2023-08-13-at-9.31.54-PM.703qm5ne67k0.webp" alt="Screenshot-2023-08-13-at-9"></p> <h4 id="_1、按钮-仅设置背景颜色-border"><a href="#_1、按钮-仅设置背景颜色-border" class="header-anchor">#</a> 1、按钮 仅设置背景颜色+border</h4> <div class="language- line-numbers-mode"><pre class="language-text"><code>  let btn01 = UIButton(type: .custom)
  btn01.frame = CGRect(x: 100, y: 200, width: 100, height: 100)
  //设置圆角
  btn01.layer.cornerRadius = 50
  //设置border宽度和颜色
  btn01.layer.borderWidth = 4
  btn01.layer.borderColor = UIColor.red.cgColor
  self.view.addSubview(btn01)
  //设置背景颜色
  btn01.backgroundColor = UIColor.green
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>在这种情况下，无论是使用默认的maskToBounds / clipsToBounds（false），还是将其修改为true，都不会触发离屏渲染，究其根本原因是 contents中没有需要圆角处理的layer。</p> <p><img src="https://cdn.staticaly.com/gh/214070779/picx-images-hosting@master/20230813/Screenshot-2023-08-13-at-9.33.22-PM.3htcznxxjk80.webp" alt="Screenshot-2023-08-13-at-9"></p> <h4 id="按钮设置背景图片-boder"><a href="#按钮设置背景图片-boder" class="header-anchor">#</a> 按钮设置背景图片+boder</h4> <div class="language- line-numbers-mode"><pre class="language-text"><code>let btn0 = UIButton(type: .custom)
btn0.frame = CGRect(x: 100, y: 60, width: 100, height: 100)
//设置圆角
btn0.layer.cornerRadius = 50
//设置border宽度和颜色
btn0.layer.borderWidth = 2
btn0.layer.borderColor = UIColor.red.cgColor
self.view.addSubview(btn0)
//设置背景图片
btn0.setImage(UIImage(named: &quot;mouse&quot;), for: .normal)
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>使用默认的maskToBounds / clipsToBounds（false）
这种情况就是最开始我们讲到的圆角设置不生效的情况，就不再多做说明了</p> <p>maskToBounds / clipsToBounds 修改为true
<img src="https://cdn.staticaly.com/gh/214070779/picx-images-hosting@master/20230813/Screenshot-2023-08-13-at-9.34.45-PM.u8frc7ves80.webp" alt="Screenshot-2023-08-13-at-9"></p> <p>从屏幕的显示上可以看出，此时触发了离屏渲染，是因为圆角的设置是需要对所有layer都进行裁剪的，而maskToBounds裁剪是应用到所有layer上的。如果从正常渲染的角度来说，一个个layer是用完即扔的。而现在我们的圆角设置需要3个layer叠加合并的，所以将先处理好的layer保存在离屏缓冲区，等到最后一个layer处理完，合并进行圆角+裁剪，所以才会触发离屏渲染</p> <p>总结</p> <p>当只设置backgroundColor、border，而contents中没有子视图时，无论maskToBounds / clipsToBounds是true还是false，都不会触发离屏渲染
当contents中有子视图时，此时设置 cornerRadius+maskToBounds / clipsToBounds,就会触发离屏渲染</p> <h2 id="如何减少离屏渲染"><a href="#如何减少离屏渲染" class="header-anchor">#</a> 如何减少离屏渲染</h2> <p>RoundedCorner（圆角） 在仅指定cornerRadius时不会触发离屏渲染，仅适用于特殊情况：contents为 nil 或者contents不会遮挡背景色时的圆角。 最简单的就是让UI同事切一个带圆角的图。</p> <p>Shawdow 可以通过指定路径来取消离屏渲染。</p> <p>Mask 无法取消离屏渲染，可以利用混合图层来进行优化。</p> <p>如果内容contents没有内容，只有背景色，就不用使用masksToBounds/ClipsToBounds了。直接设置cornerRadius就好了。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">//按钮设置背景图，会离屏</span>
UIButton <span class="token operator">*</span>btn1 <span class="token operator">=</span> <span class="token punctuation">[</span>UIButton buttonWithType<span class="token operator">:</span>UIButtonTypeCustom<span class="token punctuation">]</span><span class="token punctuation">;</span>
btn1<span class="token punctuation">.</span>frame <span class="token operator">=</span> <span class="token function">CGRectMake</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">[</span>btn1 setImage<span class="token operator">:</span><span class="token punctuation">[</span>UIImage imageNamed<span class="token operator">:</span>@<span class="token string">&quot;测试.png&quot;</span><span class="token punctuation">]</span> forState<span class="token operator">:</span>UIControlStateNormal<span class="token punctuation">]</span><span class="token punctuation">;</span>
btn1<span class="token punctuation">.</span>layer<span class="token punctuation">.</span>cornerRadius <span class="token operator">=</span> <span class="token number">20</span><span class="token punctuation">;</span>
btn1<span class="token punctuation">.</span>layer<span class="token punctuation">.</span>masksToBounds <span class="token operator">=</span> <span class="token constant">YES</span><span class="token punctuation">;</span>
<span class="token punctuation">[</span>self<span class="token punctuation">.</span>view addSubview<span class="token operator">:</span>btn1<span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token comment">//改为对button上的imageView裁剪圆角 这样就不会离屏渲染了</span>
UIButton <span class="token operator">*</span>btn2 <span class="token operator">=</span> <span class="token punctuation">[</span>UIButton buttonWithType<span class="token operator">:</span>UIButtonTypeCustom<span class="token punctuation">]</span><span class="token punctuation">;</span>
btn2<span class="token punctuation">.</span>frame <span class="token operator">=</span> <span class="token function">CGRectMake</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">220</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">[</span>btn2 setImage<span class="token operator">:</span><span class="token punctuation">[</span>UIImage imageNamed<span class="token operator">:</span>@<span class="token string">&quot;测试.png&quot;</span><span class="token punctuation">]</span> forState<span class="token operator">:</span>UIControlStateNormal<span class="token punctuation">]</span><span class="token punctuation">;</span>
btn2<span class="token punctuation">.</span>imageView<span class="token punctuation">.</span>layer<span class="token punctuation">.</span>cornerRadius <span class="token operator">=</span> <span class="token number">20</span><span class="token punctuation">;</span>
btn2<span class="token punctuation">.</span>imageView<span class="token punctuation">.</span>layer<span class="token punctuation">.</span>masksToBounds <span class="token operator">=</span> <span class="token constant">YES</span><span class="token punctuation">;</span>
<span class="token punctuation">[</span>self<span class="token punctuation">.</span>view addSubview<span class="token operator">:</span>btn2<span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><h2 id="ios中图像显示原理-图像加载过程"><a href="#ios中图像显示原理-图像加载过程" class="header-anchor">#</a> iOS中图像显示原理 == 图像加载过程</h2> <p>iOS从磁盘加载一张图片，使用UIImageView显示在屏幕上，加载流程如下:</p> <p>我们使用 +imageWithContentsOfFile:(使用Image I/O创建CGImageRef内存映射数据)方法从磁盘中加载一张图片。此时，图片尚未解码。在这个过程中先从磁盘拷贝数据到内核缓冲区，再从内核缓冲区复制数据到用户空间。</p> <p>生成UIImageView，把图像数据赋值给UIImageView，如果图像数据未解码(PNG/JPG)，解码为位图数据。（什么是位图？别着急，往下看）
隐式CATransaction 捕获到UIImageView layer树的变化。</p> <p>在主线程的下一个 runloop 到来时，Core Animation 提交了这个隐式的 transaction ，这个过程可能会对图片进行 copy 操作，而受图片是否字节对齐等因素的影响，这个 copy 操作可能会涉及以下部分或全部步骤：</p> <ul><li><p>分配内存缓冲区用于管理文件 IO 和解压缩操作；</p></li> <li><p>将文件数据从磁盘读到内存中；</p></li> <li><p>将压缩的图片数据解码成未压缩的位图形式，这是一个非常耗时的 CPU 操作；</p></li> <li><p>然后 Core Animation 中CALayer使用未压缩的位图数据渲染 UIImageView 的图层。</p></li> <li><p>最后CPU计算好图片的Frame,对图片解压之后.就会交给GPU来做图片渲染。</p></li></ul> <p>渲染流程</p> <ul><li><p>GPU获取获取图片的坐标</p></li> <li><p>将坐标交给顶点着色器(顶点计算)</p></li> <li><p>将图片光栅化(获取图片对应屏幕上的像素点)</p></li> <li><p>片元着色器计算(计算每个像素点的最终显示的颜色值)</p></li> <li><p>从帧缓存区中渲染到屏幕上</p></li></ul> <p>在最简单的情况下，帧缓冲区只有一个，这时帧缓冲区的读取和刷新都都会有比较大的效率问题。为了解决效率问题，显示系统通常会引入两个缓冲区，即双缓冲机制。在这种情况下，GPU 会预先渲染好一帧放入一个缓冲区内，让视频控制器读取，当下一帧渲染好后，GPU 会直接把视频控制器的指针指向第二个缓冲器。如此一来效率会有很大的提升。</p> <p>双缓冲虽然能解决效率问题，但会引入一个新的问题。当视频控制器还未读取完成时，即屏幕内容刚显示一半时，GPU 将新的一帧内容提交到帧缓冲区并把两个缓冲区进行交换后，视频控制器就会把新的一帧数据的下半段显示到屏幕上，造成画面撕裂现象。</p> <p>为了解决这个问题，GPU 通常有一个机制叫做垂直同步（简写也是 V-Sync），当开启垂直同步后，GPU 会等待显示器的 VSync 信号发出后，才进行新的一帧渲染和缓冲区更新。这样能解决画面撕裂现象，也增加了画面流畅度，但需要消费更多的计算资源，也会带来部分延迟。</p> <p>从上面我们也可以看到通常计算机在显示是CPU与GPU协同合作完成一次渲染.接下来我们了解一下CPU/GPU等在这样一次渲染过程中,具体的分工是什么?</p> <ul><li>CPU: 计算视图frame，图片解码，需要绘制纹理图片通过数据总线交给GPU</li> <li>GPU: 纹理混合，顶点变换与计算,像素点的填充计算，渲染到帧缓冲区</li> <li>时钟信号：垂直同步信号V-Sync / 水平同步信号H-Sync</li> <li>iOS设备双缓冲机制：显示系统通常会引入两个帧缓冲区，双缓冲机制（从相关资料可以知道，iOS 设备会始终使用双缓存，并开启垂直同步。而安卓- 设备直到 4.1 版本，Google 才开始引入这种机制，目前安卓系统是三缓存+垂直同步）
图片显示到屏幕上是CPU与GPU的协作完成</li></ul> <p>对应用来说，图片是最占用手机内存的资源，将一张图片从磁盘中加载出来，并最终显示到屏幕上，中间其实经过了一系列复杂的处理过程。</p> <h2 id="图片的解压缩"><a href="#图片的解压缩" class="header-anchor">#</a> 图片的解压缩</h2> <p>我们上面提到了图片的解压缩是一个非常耗时的 CPU 操作，并且它默认是在主线程中执行的。那么当需要加载的图片比较多时，就会对我们应用的响应性造成严重的影响，尤其是在快速滑动的列表上，这个问题会表现得更加突出。接下来就让我们来看下图片的解压缩过程。</p> <p>图片的本质就是由许多的像素点构成的，而前面所说的位图实际上就是一个装着这些像素点的数组。而我们平时开发经常用的PNG或者JPG图片，都是一种压缩的位图图形格式。只不过 PNG图片是无损压缩，并且支持 alpha 通道。而 JPEG 图片则是有损压缩，可以指定 0-100% 的压缩比。苹果提供了以下这两个函数用来生成 PNG 和 JPEG 图片，想必大家也不陌生：</p> <div class="language-objectivec line-numbers-mode"><pre class="language-objectivec"><code><span class="token comment">// return image as PNG. May return nil if image has no CGImageRef or invalid bitmap format</span>
UIKIT_EXTERN NSData <span class="token operator">*</span> __nullable <span class="token function">UIImagePNGRepresentation</span><span class="token punctuation">(</span>UIImage <span class="token operator">*</span> __nonnull image<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// return image as JPEG. May return nil if image has no CGImageRef or invalid bitmap format. compression is 0(most)..1(least)                           </span>
UIKIT_EXTERN NSData <span class="token operator">*</span> __nullable <span class="token function">UIImageJPEGRepresentation</span><span class="token punctuation">(</span>UIImage <span class="token operator">*</span> __nonnull image<span class="token punctuation">,</span> CGFloat compressionQuality<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h2 id="离屏渲染为何性能消耗高"><a href="#离屏渲染为何性能消耗高" class="header-anchor">#</a> 离屏渲染为何性能消耗高</h2> <ol><li>创建新缓冲区</li></ol> <p>要想进行离屏渲染，首先要创建一个新的缓冲区。</p> <ol start="2"><li>上下文切换</li></ol> <p>离屏渲染的整个过程，需要多次切换上下文环境：先是从当前屏幕（On-Screen）切换到离屏（Off-Screen）；等到离屏渲染结束以后，将离屏缓冲区的渲染结果显示到屏幕上有需要将上下文环境从离屏切换到当前屏幕。而上下文环境的切换是要付出很大代价的。</p> <p>那哪些情况会Offscreen Render呢？</p> <div class="custom-block tip"><p class="custom-block-title">提示</p> <ol><li>drawRect</li> <li>layer.shouldRasterize = true;</li> <li>有mask或者是阴影(layer.masksToBounds, layer.shadow*)；
<ul><li>3.1 shouldRasterize（光栅化）</li> <li>3.2 masks（遮罩）</li> <li>3.3 shadows（阴影）</li> <li>3.4 edge antialiasing（抗锯齿）</li> <li>3.5 group opacity（不透明）</li></ul></li> <li>Text（UILabel, CATextLayer, Core Text, etc）...</li></ol> <p>注：layer.cornerRadius，layer.borderWidth，layer.borderColor并不会Offscreen Render，因为这些不需要加入Mask。</p></div> <p>需要注意的是，如果shouldRasterize被设置成YES，在触发离屏绘制的同时，会将光栅化后的内容缓存起来，如果对应的layer及其sublayers没有发生改变，在下一帧的时候可以直接复用。这将在很大程度上提升渲染性能。</p> <p>而其它属性如果是开启的，就不会有缓存，离屏绘制会在每一帧都发生。</p> <p>另一种特殊的“离屏渲染”方式：CPU渲染</p> <p>如果我们重写了drawRect方法，并且使用任何Core Graphics的技术进行了绘制操作，就涉及到了CPU渲染。整个渲染过程由CPU在App内同步地</p> <p>完成，渲染得到的bitmap最后再交由GPU用于显示。</p> <p>当前屏幕渲染、离屏渲染、CPU渲染的选择</p> <p>1.尽量使用当前屏幕渲染</p> <p>鉴于离屏渲染、CPU渲染可能带来的性能问题，一般情况下，我们要尽量使用当前屏幕渲染。</p> <p>2.离屏渲染 VS CPU渲染</p> <p>由于GPU的浮点运算能力比CPU强，CPU渲染的效率可能不如离屏渲染；但如果仅仅是实现一个简单的效果，直接使用CPU渲染的效率又可能比离屏渲染好，毕竟离屏渲染要涉及到缓冲区创建和上下文切换等耗时操作。</p> <h2 id="卡顿发生的原因"><a href="#卡顿发生的原因" class="header-anchor">#</a> 卡顿发生的原因</h2> <p>卡顿： 所谓卡顿，就是App在主线程阻塞,页面交互无法响，用户体验差的现象。
如果一个App出现了长时间的卡顿，那么极有可能流失大量用户；所以卡顿对App的负面影响巨大，是我们必须要面对并解决的问题；</p> <p>卡顿的发生通常有以下几个原因：</p> <ul><li><p>UI过于复杂，图文混排的绘制量过大；</p></li> <li><p>在主线程上进行同步的网络请求；</p></li> <li><p>在主线程上进行大量的IO操作；</p></li> <li><p>函数运算量过大，持续占用较高的CPU；</p></li> <li><p>死锁和主子线程抢锁；</p></li></ul> <h3 id="监控卡顿的指标-fps-帧率"><a href="#监控卡顿的指标-fps-帧率" class="header-anchor">#</a> 监控卡顿的指标: FPS（帧率）</h3> <div class="custom-block tip"><p class="custom-block-title">提示</p> <p>FPS是一秒钟显示的帧数，也就是一秒内画面变化的数量。如果按照我们经常看的动画片来说，那么动画片的FPS就是24，是达不到满帧的60的。也就是对于动画片来说，24帧虽然不足60帧，也没有60帧来的流畅，但是对于我们来说已经是连贯的了，所以并不是24帧就会卡顿，少于60帧更不能算是卡顿；</p></div> <h2 id="问题汇总"><a href="#问题汇总" class="header-anchor">#</a> 问题汇总</h2> <h3 id="对视图的性能优化有一些了解-你可不可以先说下-图像显示相关的原理"><a href="#对视图的性能优化有一些了解-你可不可以先说下-图像显示相关的原理" class="header-anchor">#</a> 对视图的性能优化有一些了解，你可不可以先说下 图像显示相关的原理</h3> <p>iOS系统中 CPU、GPU、显示器是以下面图中方式协同工作的。CPU和GPU是通过总线链接起来的，CPU 计算好显示内容提交到 GPU，GPU 渲染完成后将渲染结果放入帧缓冲区，视频控制器会按照 VSync 信号逐行读取帧缓冲区的数据，经过数模转换传递给显示器显示。
下图就是图像显示的流程:</p> <p><img src="https://cdn.staticaly.com/gh/214070779/picx-images-hosting@master/20230813/Screenshot-2023-08-19-at-20.34.56.6jfwa08okk40.webp" alt="Screenshot-2023-08-19-at-20"></p> <p>关于CPU和GPU的分工又有以下内容：</p> <p><strong>CPU负责：</strong></p> <ul><li>对象创建和销毁</li> <li>对象属性调整</li> <li>布局计算、文本的计算</li> <li>排版、图片的格式转换和解码</li> <li>图像的绘制</li></ul> <p><strong>GPU负责：</strong></p> <ul><li>纹理的渲染</li> <li>视图的混合</li> <li>图形的生成</li></ul> <h3 id="既然了解图像显示的原理-那你知道ios视图卡顿掉帧的原因吗"><a href="#既然了解图像显示的原理-那你知道ios视图卡顿掉帧的原因吗" class="header-anchor">#</a> 既然了解图像显示的原理，那你知道IOS视图卡顿掉帧的原因吗？</h3> <p><img src="https://cdn.staticaly.com/gh/214070779/picx-images-hosting@master/20230813/Screenshot-2023-08-19-at-20.37.18.3vqjj9dd4o40.webp" alt="Screenshot-2023-08-19-at-20"></p> <p>标准情况下，页面滑动流畅是60FPs ，就是每一秒有60帧的画面刷新，每16.7ms(1/60秒)有一帧数据。上图两个VSync 之间的时间就是16.7ms。
如果CPU 和 GPU 加起来的处理时间超过了 16.7ms，就会造成掉帧甚至卡顿。当FPs 帧数低于30时，人的肉眼就能感觉到画面明显的卡顿。</p> <h3 id="那你知道如何监控界面的卡顿吗"><a href="#那你知道如何监控界面的卡顿吗" class="header-anchor">#</a> 那你知道如何监控界面的卡顿吗</h3> <p>既然知道了造成卡顿的原因，监控卡顿的思路就有了。</p> <p>思路一监控FPS：一般来说，我们约定60FPS即为流畅。那么反过来，如果App在运行期间出现了掉帧，即可认为出现了卡顿。</p> <p>思路二监控RunLoop：监控每一帧的时长是否超时。</p> <p>思路程三Ping主线程：Ping主线程的核心思想是向主线程发送一个信号，一定时间内收到了主线程的回复，即表示当前主线程流畅运行。没有收到主线程的回复，即表示当前主线程在做耗时运算，发生了卡顿。</p> <h4 id="方案一-监控fps"><a href="#方案一-监控fps" class="header-anchor">#</a> 方案一：监控FPS</h4> <p>一般来说，我们约定60FPS即为流畅。那么反过来，如果App在运行期间出现了掉帧，即可认为出现了卡顿。</p> <p>监控FPS的方案几乎都是基于CADisplayLink实现的。简单介绍一下CADisplayLink：CADisplayLink是一个和屏幕刷新率保持一致的定时器，一但 CADisplayLink 以特定的模式注册到runloop之后，每当屏幕需要刷新的时候，runloop就会调用CADisplayLink绑定的target上的selector。</p> <p>可以通过向RunLoop中添加CADisplayLink，根据其回调来计算出当前画面的帧数。</p> <details class="custom-block details"><summary>点击查看</summary> <div class="language-objectivec line-numbers-mode"><pre class="language-objectivec"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">import</span> <span class="token string">&quot;FPSMonitor.h&quot;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">import</span> <span class="token expression"><span class="token operator">&lt;</span>UIKit<span class="token operator">/</span>UIKit<span class="token punctuation">.</span>h<span class="token operator">&gt;</span></span></span>

<span class="token keyword">@interface</span> <span class="token function">FPSMonitor</span> <span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">@property</span> <span class="token punctuation">(</span>nonatomic<span class="token punctuation">,</span> strong<span class="token punctuation">)</span> CADisplayLink<span class="token operator">*</span> link<span class="token punctuation">;</span>
<span class="token keyword">@property</span> <span class="token punctuation">(</span>nonatomic<span class="token punctuation">,</span> assign<span class="token punctuation">)</span> NSInteger count<span class="token punctuation">;</span>
<span class="token keyword">@property</span> <span class="token punctuation">(</span>nonatomic<span class="token punctuation">,</span> assign<span class="token punctuation">)</span> NSTimeInterval lastTime<span class="token punctuation">;</span>
<span class="token keyword">@end</span>

<span class="token keyword">@implementation</span> FPSMonitor

<span class="token operator">-</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>beginMonitor <span class="token punctuation">{</span>
    _link <span class="token operator">=</span> <span class="token punctuation">[</span>CADisplayLink displayLinkWithTarget<span class="token punctuation">:</span><span class="token keyword">self</span> selector<span class="token punctuation">:</span><span class="token keyword">@selector</span><span class="token punctuation">(</span>fpsInfoCaculate<span class="token punctuation">:</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">[</span>_link addToRunLoop<span class="token punctuation">:</span><span class="token punctuation">[</span>NSRunLoop mainRunLoop<span class="token punctuation">]</span> forMode<span class="token punctuation">:</span>NSRunLoopCommonModes<span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>

<span class="token operator">-</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>fpsInfoCaculate<span class="token punctuation">:</span><span class="token punctuation">(</span>CADisplayLink <span class="token operator">*</span><span class="token punctuation">)</span>sender <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>_lastTime <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        _lastTime <span class="token operator">=</span> sender<span class="token punctuation">.</span>timestamp<span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    _count<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token keyword">double</span> deltaTime <span class="token operator">=</span> sender<span class="token punctuation">.</span>timestamp <span class="token operator">-</span> _lastTime<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>deltaTime <span class="token operator">&gt;=</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        NSInteger FPS <span class="token operator">=</span> _count <span class="token operator">/</span> deltaTime<span class="token punctuation">;</span>
        _lastTime <span class="token operator">=</span> sender<span class="token punctuation">.</span>timestamp<span class="token punctuation">;</span>
        _count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token function">NSLog</span><span class="token punctuation">(</span><span class="token string">@&quot;FPS: %li&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>NSInteger<span class="token punctuation">)</span><span class="token function">ceill</span><span class="token punctuation">(</span>FPS <span class="token operator">+</span> <span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">@end</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br></div></div></details> <p>FPS的好处就是直观，小手一划后FPS下降了，说明页面的某处有性能问题。坏处就是只知道这是页面的某处，不能准确定位到具体的堆栈。</p> <h4 id="方案二-监控runloop"><a href="#方案二-监控runloop" class="header-anchor">#</a> 方案二：监控RunLoop</h4> <p>首先知道RunLoop的六个状态</p> <div class="custom-block tip"><p class="custom-block-title">提示</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>typedef CF_OPTIONS(CFOptionFlags, CFRunLoopActivity) {
    kCFRunLoopEntry         = (1UL &lt;&lt; 0), // 即将进入Loop
    kCFRunLoopBeforeTimers  = (1UL &lt;&lt; 1), // 即将处理 Timer
    kCFRunLoopBeforeSources = (1UL &lt;&lt; 2), // 即将处理 Source
    kCFRunLoopBeforeWaiting = (1UL &lt;&lt; 5), // 即将进入休眠
    kCFRunLoopAfterWaiting  = (1UL &lt;&lt; 6), // 刚从休眠中唤醒
    kCFRunLoopExit          = (1UL &lt;&lt; 7), // 即将退出Loop
kCFRunLoopAllActivities // loop所有状态改变

};
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div></div> <p>要想监听RunLoop，你就首先需要创建一个 CFRunLoopObserverContext 观察者，代码如下:</p> <div class="custom-block tip"><p class="custom-block-title">提示</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>- (void)registerObserver {

    CFRunLoopObserverContext context = {0,(__bridge void*)self,NULL,NULL};
    //创建Run loop observer对象
    //第一个参数用于分配observer对象的内存
    //第二个参数用以设置observer所要关注的事件，详见回调函数myRunLoopObserver中注释
    //第三个参数用于标识该observer是在第一次进入run loop时执行还是每次进入run loop处理时均执行
    //第四个参数用于设置该observer的优先级
    //第五个参数用于设置该observer的回调函数
    //第六个参数用于设置该observer的运行环境
    CFRunLoopObserverRef observer = CFRunLoopObserverCreate(kCFAllocatorDefault,
                                                            kCFRunLoopAllActivities,
                                                            YES,
                                                            0,
                                                            &amp;runLoopObserverCallBack,
                                                            &amp;context);
    CFRunLoopAddObserver(CFRunLoopGetMain(), observer, kCFRunLoopCommonModes);

}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div></div> <p>实时获取变化的回调的方法：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>//每当runloop状态变化的触发这个回调方法
static void runLoopObserverCallBack(CFRunLoopObserverRef observer, CFRunLoopActivity activity, void *info) {
    MyClass *object = (__bridge MyClass*)info;
    object-&gt;activity = activity;
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>其中UI主要集中在</p> <p>_CFRUNLOOP_IS_CALLING_OUT_TO_A_SOURCE0_PERFORM_FUNCTION(source0)和</p> <p>CFRUNLOOP_IS_CALLING_OUT_TO_A_SOURCE1_PERFORM_FUNCTION(source1)之前。</p> <p>获取kCFRunLoopBeforeSources到kCFRunLoopBeforeWaiting再到kCFRunLoopAfterWaiting的状态就可以知道是否有卡顿的情况。</p> <p><img src="https://cdn.staticaly.com/gh/214070779/picx-images-hosting@master/20230813/be9a2b9fd4f7bc85364b92d07a393ed5.55z6ax64gxs0.webp" alt="be9a2b9fd4f7bc85364b92d07a393ed5"></p> <p>根据这张图可以看出：RunLoop在BeforeSources和AfterWaiting后会进行任务的处理。可以在此时阻塞监控线程并设置超时时间，若超时后RunLoop的状态仍为RunLoop在BeforeSources或AfterWaiting，表明此时RunLoop仍然在处理任务，主线程发生了卡顿。</p> <details class="custom-block details"><summary>点击查看</summary> <div class="language-objectivec line-numbers-mode"><pre class="language-objectivec"><code><span class="token operator">-</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>beginMonitor <span class="token punctuation">{</span>
    <span class="token keyword">self</span><span class="token punctuation">.</span>dispatchSemaphore <span class="token operator">=</span> <span class="token function">dispatch_semaphore_create</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 第一个监控，监控是否处于 运行状态</span>
    CFRunLoopObserverContext context <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>__bridge <span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">self</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">self</span><span class="token punctuation">.</span>runLoopBeginObserver <span class="token operator">=</span> <span class="token function">CFRunLoopObserverCreate</span><span class="token punctuation">(</span>kCFAllocatorDefault<span class="token punctuation">,</span>
                                                        kCFRunLoopAllActivities<span class="token punctuation">,</span>
                                                        YES<span class="token punctuation">,</span>
                                                        LONG_MIN<span class="token punctuation">,</span>
                                                        <span class="token operator">&amp;</span>myRunLoopBeginCallback<span class="token punctuation">,</span>
                                                        <span class="token operator">&amp;</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//  第二个监控，监控是否处于 睡眠状态</span>
    <span class="token keyword">self</span><span class="token punctuation">.</span>runLoopEndObserver <span class="token operator">=</span> <span class="token function">CFRunLoopObserverCreate</span><span class="token punctuation">(</span>kCFAllocatorDefault<span class="token punctuation">,</span>
                                                      kCFRunLoopAllActivities<span class="token punctuation">,</span>
                                                      YES<span class="token punctuation">,</span>
                                                      LONG_MAX<span class="token punctuation">,</span>
                                                      <span class="token operator">&amp;</span>myRunLoopEndCallback<span class="token punctuation">,</span>
                                                      <span class="token operator">&amp;</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">CFRunLoopAddObserver</span><span class="token punctuation">(</span><span class="token function">CFRunLoopGetMain</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">self</span><span class="token punctuation">.</span>runLoopBeginObserver<span class="token punctuation">,</span> kCFRunLoopCommonModes<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">CFRunLoopAddObserver</span><span class="token punctuation">(</span><span class="token function">CFRunLoopGetMain</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">self</span><span class="token punctuation">.</span>runLoopEndObserver<span class="token punctuation">,</span> kCFRunLoopCommonModes<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 创建子线程监控</span>
    <span class="token function">dispatch_async</span><span class="token punctuation">(</span><span class="token function">dispatch_get_global_queue</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">^</span><span class="token punctuation">{</span>
        <span class="token comment">//子线程开启一个持续的loop用来进行监控</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>YES<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">long</span> semaphoreWait <span class="token operator">=</span> <span class="token function">dispatch_semaphore_wait</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">.</span>dispatchSemaphore<span class="token punctuation">,</span> <span class="token function">dispatch_time</span><span class="token punctuation">(</span>DISPATCH_TIME_NOW<span class="token punctuation">,</span> <span class="token number">17</span> <span class="token operator">*</span> NSEC_PER_MSEC<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>semaphoreWait <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">self</span><span class="token punctuation">.</span>runLoopBeginObserver <span class="token operator">||</span> <span class="token operator">!</span><span class="token keyword">self</span><span class="token punctuation">.</span>runLoopEndObserver<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">self</span><span class="token punctuation">.</span>timeoutCount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                    <span class="token keyword">self</span><span class="token punctuation">.</span>dispatchSemaphore <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                    <span class="token keyword">self</span><span class="token punctuation">.</span>runLoopBeginActivity <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                    <span class="token keyword">self</span><span class="token punctuation">.</span>runLoopEndActivity <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment">// 两个runloop的状态，BeforeSources和AfterWaiting这两个状态区间时间能够检测到是否卡顿</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">.</span>runLoopBeginActivity <span class="token operator">==</span> kCFRunLoopBeforeSources <span class="token operator">||</span> <span class="token keyword">self</span><span class="token punctuation">.</span>runLoopBeginActivity <span class="token operator">==</span> kCFRunLoopAfterWaiting<span class="token punctuation">)</span> <span class="token operator">||</span>
                    <span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">.</span>runLoopEndActivity <span class="token operator">==</span> kCFRunLoopBeforeSources <span class="token operator">||</span> <span class="token keyword">self</span><span class="token punctuation">.</span>runLoopEndActivity <span class="token operator">==</span> kCFRunLoopAfterWaiting<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">// 出现三次出结果</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">++</span><span class="token keyword">self</span><span class="token punctuation">.</span>timeoutCount <span class="token operator">&lt;</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">continue</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token function">NSLog</span><span class="token punctuation">(</span><span class="token string">@&quot;调试：监测到卡顿&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token comment">// end activity</span>
            <span class="token punctuation">}</span><span class="token comment">// end semaphore wait</span>
            <span class="token keyword">self</span><span class="token punctuation">.</span>timeoutCount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token comment">// end while</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 第一个监控，监控是否处于 运行状态</span>
<span class="token keyword">void</span> <span class="token function">myRunLoopBeginCallback</span><span class="token punctuation">(</span>CFRunLoopObserverRef observer<span class="token punctuation">,</span> CFRunLoopActivity activity<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>info<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    RunLoopMonitor2<span class="token operator">*</span> lagMonitor <span class="token operator">=</span> <span class="token punctuation">(</span>__bridge RunLoopMonitor2 <span class="token operator">*</span><span class="token punctuation">)</span>info<span class="token punctuation">;</span>
    lagMonitor<span class="token punctuation">.</span>runLoopBeginActivity <span class="token operator">=</span> activity<span class="token punctuation">;</span>
    dispatch_semaphore_t semaphore <span class="token operator">=</span> lagMonitor<span class="token punctuation">.</span>dispatchSemaphore<span class="token punctuation">;</span>
    <span class="token function">dispatch_semaphore_signal</span><span class="token punctuation">(</span>semaphore<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">//  第二个监控，监控是否处于 睡眠状态</span>
<span class="token keyword">void</span> <span class="token function">myRunLoopEndCallback</span><span class="token punctuation">(</span>CFRunLoopObserverRef observer<span class="token punctuation">,</span> CFRunLoopActivity activity<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>info<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    RunLoopMonitor2<span class="token operator">*</span> lagMonitor <span class="token operator">=</span> <span class="token punctuation">(</span>__bridge RunLoopMonitor2 <span class="token operator">*</span><span class="token punctuation">)</span>info<span class="token punctuation">;</span>
    lagMonitor<span class="token punctuation">.</span>runLoopEndActivity <span class="token operator">=</span> activity<span class="token punctuation">;</span>
    dispatch_semaphore_t semaphore <span class="token operator">=</span> lagMonitor<span class="token punctuation">.</span>dispatchSemaphore<span class="token punctuation">;</span>
    <span class="token function">dispatch_semaphore_signal</span><span class="token punctuation">(</span>semaphore<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br></div></div></details> <p>UIApplicationMain函数内部会启动主线程的RunLoop，使得iOS程序持续运行。</p> <p>iOS系统中有两套API来使用RunLoop，NSRunLoop（CFRunLoopRef的封装）和CFRunLoopRef。Foundation框架是不开源的，可以通过开源的CoreFoundation来分析RunLoop内部实现。</p> <h4 id="方案三-ping主线程"><a href="#方案三-ping主线程" class="header-anchor">#</a> 方案三：Ping主线程</h4> <p>Ping主线程的核心思想是向主线程发送一个信号，一定时间内收到了主线程的回复，即表示当前主线程流畅运行。没有收到主线程的回复，即表示当前主线程在做耗时运算，发生了卡顿。</p> <p>目前昆虫线上使用的就是这套方案。</p> <details class="custom-block details"><summary>点击查看</summary> <div class="language-objectivec line-numbers-mode"><pre class="language-objectivec"><code><span class="token keyword">self</span><span class="token punctuation">.</span>semaphore <span class="token operator">=</span> <span class="token function">dispatch_semaphore_create</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">-</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>main <span class="token punctuation">{</span>
    <span class="token comment">//判断是否需要上报</span>
    __weak <span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">)</span> weakSelf <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">^</span> verifyReport<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token operator">^</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        __strong <span class="token keyword">typeof</span><span class="token punctuation">(</span>weakSelf<span class="token punctuation">)</span> strongSelf <span class="token operator">=</span> weakSelf<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>strongSelf<span class="token punctuation">.</span>reportInfo<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>strongSelf<span class="token punctuation">.</span>handler<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">double</span> responseTimeValue <span class="token operator">=</span> <span class="token function">floor</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span>NSDate date<span class="token punctuation">]</span> timeIntervalSince1970<span class="token punctuation">]</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">double</span> duration <span class="token operator">=</span> responseTimeValue <span class="token operator">-</span> strongSelf<span class="token punctuation">.</span>startTimeValue<span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>DEBUG<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token function">NSLog</span><span class="token punctuation">(</span><span class="token string">@&quot;卡了%f,堆栈为--%@&quot;</span><span class="token punctuation">,</span> duration<span class="token punctuation">,</span> strongSelf<span class="token punctuation">.</span>reportInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                strongSelf<span class="token punctuation">.</span><span class="token function">handler</span><span class="token punctuation">(</span><span class="token operator">@</span><span class="token punctuation">{</span>
                    <span class="token string">@&quot;title&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>InsectUtil dateFormatNow<span class="token punctuation">]</span><span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">?</span> <span class="token punctuation">[</span>InsectUtil dateFormatNow<span class="token punctuation">]</span> <span class="token punctuation">:</span> <span class="token string">@&quot;&quot;</span><span class="token punctuation">,</span>
                    <span class="token string">@&quot;duration&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>NSString stringWithFormat<span class="token punctuation">:</span><span class="token string">@&quot;%.2f&quot;</span><span class="token punctuation">,</span>duration<span class="token punctuation">]</span><span class="token punctuation">,</span>
                    <span class="token string">@&quot;content&quot;</span><span class="token punctuation">:</span> strongSelf<span class="token punctuation">.</span>reportInfo
                                   <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            strongSelf<span class="token punctuation">.</span>reportInfo <span class="token operator">=</span> <span class="token string">@&quot;&quot;</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">self</span><span class="token punctuation">.</span>cancelled<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>_isApplicationInActive<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">self</span><span class="token punctuation">.</span>mainThreadBlock <span class="token operator">=</span> YES<span class="token punctuation">;</span>
            <span class="token keyword">self</span><span class="token punctuation">.</span>reportInfo <span class="token operator">=</span> <span class="token string">@&quot;&quot;</span><span class="token punctuation">;</span>
            <span class="token keyword">self</span><span class="token punctuation">.</span>startTimeValue <span class="token operator">=</span> <span class="token function">floor</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span>NSDate date<span class="token punctuation">]</span> timeIntervalSince1970<span class="token punctuation">]</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">dispatch_async</span><span class="token punctuation">(</span><span class="token function">dispatch_get_main_queue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">^</span><span class="token punctuation">{</span>
                <span class="token keyword">self</span><span class="token punctuation">.</span>mainThreadBlock <span class="token operator">=</span> NO<span class="token punctuation">;</span>
                <span class="token function">dispatch_semaphore_signal</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">.</span>semaphore<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">[</span>NSThread sleepForTimeInterval<span class="token punctuation">:</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">.</span>threshold<span class="token operator">/</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">.</span>isMainThreadBlock<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">self</span><span class="token punctuation">.</span>reportInfo <span class="token operator">=</span> <span class="token punctuation">[</span>InsectBacktraceLogger insect_backtraceOfMainThread<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token function">dispatch_semaphore_wait</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">.</span>semaphore<span class="token punctuation">,</span> DISPATCH_TIME_FOREVER<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//卡顿超时情况;</span>
            <span class="token function">verifyReport</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token punctuation">[</span>NSThread sleepForTimeInterval<span class="token punctuation">:</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">.</span>threshold<span class="token operator">/</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br></div></div></details> <p>三种方案总结:</p> <table><thead><tr><th>方案</th> <th>优点</th> <th>缺点</th> <th>实现复杂性</th></tr></thead> <tbody><tr><td>FPS</td> <td>直观</td> <td>无法准确定位卡顿堆栈</td> <td>简单</td></tr> <tr><td>RunLoop Observer</td> <td>能定位卡顿堆栈</td> <td>不能记录卡顿时间，定义卡顿的阈值不好控制</td> <td>复杂</td></tr> <tr><td>Ping Main Thread</td> <td>能定位卡顿堆栈，能记录卡顿时间</td> <td>一直ping主线程，费电</td> <td>中等</td></tr></tbody></table> <h3 id="如何优化掉帧卡顿"><a href="#如何优化掉帧卡顿" class="header-anchor">#</a> 如何优化掉帧卡顿</h3> <p>图像显示的工作是由CPU和GPU协同完成的， 那么优化的方向和思路就是尽量减少他们的处理时长。</p> <p><strong>对CPU处理的优化:</strong></p> <ul><li>简单总结：</li></ul> <p>对象的创建，释放，属性调整。这里尤其要提一下属性调整，CALayer的属性调整的时候是会创建隐式动画的，是比较损耗性能的。</p> <p>视图和文本的布局计算，AutoLayout的布局计算都是在主线程上的，所以占用CPU时间也很多 。</p> <p>文本渲染，诸如UILabel和UITextview都是在主线程渲染的</p> <p>图片的解码，这里要提到的是，通常UIImage只有在交给GPU之前的一瞬间，CPU才会对其解码。</p> <p>————————————————</p> <ul><li>详细说明：</li></ul> <ol><li><p>尽量用轻量级的对象代替重量级的对象，可以对性能有所优化，例如 不需要相应触摸事件的控件，用CALayer代替UIView</p></li> <li><p>尽量减少对UIView和CALayer的属性修改</p></li></ol> <p>CALayer内部并没有属性，当调用属性方法时，其内部是通过运行时resolveInstanceMethod为对象临时添加一个方法，并将对应属性值保存在内部的一个Dictionary中，同时还会通知delegate、创建动画等，非常耗时</p> <p>UIView相关的显示属性，例如frame、bounds、transform等，实际上都是从CALayer映射来的，对其进行调整时，消耗的资源比一般属性要大</p> <ol start="3"><li><p>当有大量对象释放时，也是非常耗时的，尽量挪到后台线程去释放</p></li> <li><p>尽量提前计算视图布局，即预排版，例如cell的行高</p></li> <li><p>Autolayout在简单页面情况下们可以很好的提升开发效率，但是对于复杂视图而言，会产生严重的性能问题，随着视图数量的增长，Autolayout带来的CPU消耗是呈指数上升的。所以尽量使用代码布局。如果不想手动调整frame等，也可以借助三方库，例如Masonry（OC）、SnapKit（Swift）、ComponentKit、AsyncDisplayKit等</p></li> <li><p>文本处理的优化：当一个界面有大量文本时，其行高的计算、绘制也是非常耗时的</p></li></ol> <p>1）如果对文本没有特殊要求，可以使用UILabel内部的实现方式，且需要放到子线程中进行，避免阻塞主线程</p> <p>计算文本宽高：[NSAttributedString boundingRectWithSize:options:context:]</p> <p>文本绘制：[NSAttributedString drawWithRect:options:context:]</p> <p>2）自定义文本控件，利用TextKit 或最底层的 CoreText 对文本异步绘制。并且CoreText 对象创建好后，能直接获取文本的宽高等信息，避免了多次计算（调整和绘制都需要计算一次）。CoreText直接使用了CoreGraphics占用内存小，效率高</p> <ol start="7"><li>图片处理（解码 + 绘制）</li></ol> <p>1）当使用UIImage 或 CGImageSource 的方法创建图片时，图片的数据不会立即解码，而是在设置时解码（即图片设置到UIImageView/CALayer.contents中，然后在CALayer提交至GPU渲染前，CGImage中的数据才进行解码）。这一步是无可避免的，且是发生在主线程中的。想要绕开这个机制，常见的做法是在子线程中先将图片绘制到CGBitmapContext，然后从Bitmap 直接创建图片，例如SDWebImage三方框架中对图片编解码的处理。这就是Image的预解码</p> <p>当使用CG开头的方法绘制图像到画布中，然后从画布中创建图片时，可以将图像的绘制在子线程中进行</p> <ol start="8"><li>图片优化</li></ol> <p>1）尽量使用PNG图片，不使用JPGE图片</p> <p>2）通过子线程预解码，主线程渲染，即通过Bitmap创建图片，在子线程赋值image</p> <p>3）优化图片大小，尽量避免动态缩放</p> <p>4）尽量将多张图合为一张进行显示</p> <ol start="9"><li><p>尽量避免使用透明view，因为使用透明view，会导致在GPU中计算像素时，会将透明view下层图层的像素也计算进来，即颜色混合处理</p></li> <li><p>按需加载，例如在TableView中滑动时不加载图片，使用默认占位图，而是在滑动停止时加载</p></li> <li><p>少使用addView 给cell动态添加view</p></li></ol> <p><strong>对GPU处理的优化</strong></p> <p>相对于CPU而言，GPU主要是接收CPU提交的纹理+顶点，经过一系列transform，最终混合并渲染，输出到屏幕上。</p> <ol><li><p>尽量减少在短时间内大量图片的显示，尽可能将多张图片合为一张显示，主要是因为当有大量图片进行显示时，无论是CPU的计算还是GPU的渲染，都是非常耗时的，很可能出现掉帧的情况</p></li> <li><p>尽量避免图片的尺寸超过4096×4096，因为当图片超过这个尺寸时，会先由CPU进行预处理，然后再提交给GPU处理，导致额外CPU资源消耗</p></li> <li><p>尽量减少视图数量和层次，主要是因为视图过多且重叠时，GPU会将其混合，混合的过程也是非常耗时的</p></li> <li><p>尽量避免离屏渲染</p></li> <li><p>异步渲染，例如可以将cell中的所有控件、视图合成一张图片进行显示。</p></li></ol></div></div> <!----> <div class="page-edit"><div class="edit-link"><a href="https://github.com/xugaoyi/vuepress-theme-vdoing/edit/master/docs/02.技术/05.iOS基础知识/08.离屏渲染系列/00.离屏渲染.md" target="_blank" rel="noopener noreferrer">编辑</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <!----> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">2024/10/23, 23:26:17</span></div></div> <div class="page-nav-wapper"><div class="page-nav-centre-wrap"><a href="/pages/1a56ed/" class="page-nav-centre page-nav-centre-prev"><div class="tooltip">UI系列</div></a> <a href="/pages/a97536/" class="page-nav-centre page-nav-centre-next"><div class="tooltip">图片相关的问题</div></a></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/pages/1a56ed/" class="prev">UI系列</a></span> <span class="next"><a href="/pages/a97536/">图片相关的问题</a>→
      </span></p></div></div></div> <div class="article-list"><div class="article-title"><a href="/archives" class="iconfont icon-bi">最近更新</a></div> <div class="article-wrapper"><dl><dd>01</dd> <dt><a href="/pages/1e9b25/"><div>
            排序算法
            <!----></div></a> <span class="date">10-22</span></dt></dl><dl><dd>02</dd> <dt><a href="/pages/f27637/"><div>
            学习数据结构和算法的高效方法
            <!----></div></a> <span class="date">10-19</span></dt></dl><dl><dd>03</dd> <dt><a href="/pages/39672b/"><div>
            时间复杂度跟空间复杂度
            <!----></div></a> <span class="date">10-19</span></dt></dl> <dl><dd></dd> <dt><a href="/archives" class="more">更多文章&gt;</a></dt></dl></div></div></main></div> <div class="footer"><div class="icons"><a href="mailto:yangzai2140@163.com" title="发邮件" target="_blank" class="iconfont icon-youjian"></a><a href="https://github.com/214070779" title="GitHub" target="_blank" class="iconfont icon-github"></a><a href="https://music.163.com/#/playlist?id=755597173" title="听音乐" target="_blank" class="iconfont icon-erji"></a></div> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="本站主题">Vdoing</a> 
    | Copyright © 2019-2024
    <span>Evan Xu | <a href="https://github.com/xugaoyi/vuepress-theme-vdoing/blob/master/LICENSE" target="_blank">MIT License</a></span></div> <div class="buttons"><div title="返回顶部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去评论" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主题模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          跟随系统
        </li><li class="iconfont icon-rijianmoshi">
          浅色模式
        </li><li class="iconfont icon-yejianmoshi">
          深色模式
        </li><li class="iconfont icon-yuedu">
          阅读模式
        </li></ul></div></div> <!----> <!----> <!----></div><div class="global-ui"><div></div></div></div>
    <script src="/assets/js/app.cc55d274.js" defer></script><script src="/assets/js/2.81b2a5fe.js" defer></script><script src="/assets/js/58.4de20d90.js" defer></script>
  </body>
</html>
